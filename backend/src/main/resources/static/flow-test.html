<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voin - Ï†ÑÏ≤¥ ÌîåÎ°úÏö∞ ÌÖåÏä§Ìä∏</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
      }

      .content {
        padding: 30px;
      }

      .step {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .step.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .step-title {
        font-size: 1.8em;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .step-number {
        background: #667eea;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
        font-weight: bold;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn.kakao {
        background: #fee500;
        color: #000000;
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.secondary:hover {
        background: #5a6268;
        box-shadow: 0 8px 16px rgba(108, 117, 125, 0.3);
      }

      .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
      }

      .input-group {
        margin: 15px 0;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .card {
        border: 2px solid #eee;
        border-radius: 12px;
        padding: 20px;
        background: white;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .card.selected {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .card h3 {
        color: #333;
        margin-bottom: 10px;
      }

      .card p {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
      }

      .keyword-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 20px 0;
      }

      .keyword-tag {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .keyword-tag:hover {
        background: #e9ecef;
      }

      .keyword-tag.selected {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        border-left: 4px solid #667eea;
      }

      .status.success {
        background: #d1edda;
        border-left-color: #28a745;
        color: #155724;
      }

      .status.error {
        background: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .progress-bar {
        background: #f8f9fa;
        height: 8px;
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
      }

      .coin-selection {
        margin: 20px 0;
      }

      .coin-category {
        margin-bottom: 30px;
      }

      .coin-category h3 {
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid #667eea;
      }

      /* ÏÉàÎ°úÏö¥ ÏΩîÏù∏ ÏÑ†ÌÉù UI Ïä§ÌÉÄÏùº */
      .categories {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .category-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 1px solid #ddd;
        background-color: #f5f5f5;
        color: #555;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
      }

      .category-btn:hover {
        border-color: #667eea;
        background-color: #f0f4ff;
      }

      .category-btn.selected {
        background-color: #667eea;
        color: white;
        border-color: #667eea;
      }

      .keyword-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .keyword-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 24px 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        font-size: 14px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .keyword-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .keyword-card.selected {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
      }

      .keyword-card.selected::before {
        content: "‚úì ";
        margin-right: 4px;
      }

      .summary-box {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin: 24px 0;
        text-align: left;
        border: 1px solid #e9ecef;
      }

      .summary-box p {
        margin: 8px 0;
        line-height: 1.5;
      }

      .summary-box strong {
        color: #495057;
      }

      .final-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin: 20px 0;
        text-align: center;
      }

      .final-card h2 {
        margin-bottom: 20px;
      }

      .selected-items {
        background: white;
        color: #333;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ü™ô VOIN Ï†ÑÏ≤¥ ÌîåÎ°úÏö∞ ÌÖåÏä§Ìä∏</h1>
        <p>Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏Î∂ÄÌÑ∞ Ïπ¥Îìú ÏÉùÏÑ±ÍπåÏßÄ Ï†ÑÏ≤¥ Í≥ºÏ†ïÏùÑ ÌÖåÏä§Ìä∏Ìï¥Î≥¥ÏÑ∏Ïöî</p>
      </div>

      <div class="content">
        <!-- ÏßÑÌñâÎ•† ÌëúÏãú -->
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- 1Îã®Í≥Ñ: Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ -->
        <div class="step active" id="loginStep">
          <div class="step-title">
            <span class="step-number">1</span>
            Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏
          </div>
          <p style="margin-bottom: 20px">
            Î®ºÏ†Ä Ïπ¥Ïπ¥Ïò§ Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.
          </p>
          <button class="btn kakao" onclick="startKakaoLogin()">
            üçØ Ïπ¥Ïπ¥Ïò§Î°ú Î°úÍ∑∏Ïù∏ÌïòÍ∏∞
          </button>
          <div id="loginStatus" class="status" style="display: none"></div>
        </div>

        <!-- 2Îã®Í≥Ñ: ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï (Ïã†Í∑ú ÌöåÏõêÎßå) -->
        <div class="step" id="nicknameStep">
          <div class="step-title">
            <span class="step-number">2</span>
            ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï
          </div>
          <p style="margin-bottom: 20px">ÏÇ¨Ïö©ÌïòÏã§ ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
          <div class="input-group">
            <label for="nickname">ÎãâÎÑ§ÏûÑ</label>
            <input
              type="text"
              id="nickname"
              placeholder="2-10ÏûêÏùò ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              maxlength="10"
            />
          </div>
          <div class="btn-group" style="margin-top: 20px">
            <button
              class="btn secondary"
              onclick="goToPreviousStep('nicknameStep')"
            >
              Ïù¥Ï†Ñ
            </button>
            <button class="btn" onclick="setNickname()">Îã§Ïùå Îã®Í≥Ñ</button>
          </div>
          <div id="nicknameStatus" class="status" style="display: none"></div>
        </div>

        <!-- 3Îã®Í≥Ñ: ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï (Ïã†Í∑ú ÌöåÏõêÎßå) -->
        <div class="step" id="profileStep">
          <div class="step-title">
            <span class="step-number">3</span>
            ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
          </div>
          <p style="margin-bottom: 20px">ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
          <div class="card-grid" id="profileImages">
            <!-- ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏòµÏÖòÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
          </div>
          <div class="btn-group" style="margin-top: 20px">
            <button
              class="btn secondary"
              onclick="goToPreviousStep('profileStep')"
            >
              Ïù¥Ï†Ñ
            </button>
            <button
              class="btn"
              onclick="setProfileImage()"
              id="profileBtn"
              disabled
            >
              Îã§Ïùå Îã®Í≥Ñ
            </button>
          </div>
          <div id="profileStatus" class="status" style="display: none"></div>
        </div>

        <!-- 4Îã®Í≥Ñ: ÏΩîÏù∏ Ï∞æÍ∏∞ Ïú†Ìòï ÏÑ†ÌÉù -->
        <div class="step" id="coinFinderStep">
          <div class="step-title">
            <span class="step-number">4</span>
            ÏΩîÏù∏ Ï∞æÍ∏∞ Ïú†Ìòï ÏÑ†ÌÉù
          </div>
          <p style="margin-bottom: 20px">Ïñ¥Îñ§ Î∞©ÏãùÏúºÎ°ú Ïû•Ï†êÏùÑ Ï∞æÏïÑÎ≥ºÍπåÏöî?</p>
          <div class="card-grid" id="finderTypes">
            <!-- ÏΩîÏù∏ Ï∞æÍ∏∞ Ïú†ÌòïÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
          </div>
          <div id="finderStatus" class="status" style="display: none"></div>
        </div>

        <!-- 5Îã®Í≥Ñ: Ïò§ÎäòÏùò ÏùºÍ∏∞ ÏûëÏÑ± -->
        <div class="step" id="diaryStep">
          <div class="step-title">
            <span class="step-number">5</span>
            Ïò§ÎäòÏùò ÏùºÍ∏∞ ÏûëÏÑ±
          </div>
          <p style="margin-bottom: 20px">
            Ïò§Îäò ÌïòÎ£®Î•º ÎèåÏïÑÎ≥¥Î©∞ ÏùºÍ∏∞Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.
          </p>
          <div class="input-group">
            <label for="diaryContent">Ïò§ÎäòÏùò ÏùºÍ∏∞</label>
            <textarea
              id="diaryContent"
              rows="6"
              placeholder="Ïò§Îäò ÌïòÎ£® Ïñ¥Îñ§ ÏùºÏù¥ ÏûàÏóàÎÇòÏöî? Ïñ¥Îñ§ Í∏∞Î∂ÑÏù¥ÏóàÎÇòÏöî?"
            ></textarea>
          </div>
          <div class="btn-group" style="margin-top: 20px">
            <button
              class="btn secondary"
              onclick="goToPreviousStep('diaryStep')"
            >
              Ïù¥Ï†Ñ
            </button>
            <button class="btn" onclick="saveDiary()">
              ÏùºÍ∏∞ Ï†ÄÏû•ÌïòÍ≥† Îã§Ïùå Îã®Í≥Ñ
            </button>
          </div>
          <div id="diaryStatus" class="status" style="display: none"></div>
        </div>

        <!-- 6Îã®Í≥Ñ: ÏΩîÏù∏ ÏÑ†ÌÉù -->
        <div class="step" id="coinSelectionStep">
          <div class="step-title">
            <span class="step-number">6</span>
            ÏΩîÏù∏ ÏÑ†ÌÉù
          </div>
          <p style="margin-bottom: 20px">ÎÇòÏóêÍ≤å ÎßûÎäî ÏΩîÏù∏ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</p>
          <div class="coin-selection" id="coinOptions">
            <!-- ÏΩîÏù∏ ÏòµÏÖòÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
          </div>
          <div class="btn-group" style="margin-top: 20px">
            <button
              class="btn secondary"
              onclick="goToPreviousStep('coinSelectionStep')"
            >
              Ïù¥Ï†Ñ
            </button>
          </div>
          <div
            id="coinSelectionStatus"
            class="status"
            style="display: none"
          ></div>
        </div>

        <!-- 7Îã®Í≥Ñ: ÌÇ§ÏõåÎìú ÏÑ†ÌÉù -->
        <div class="step" id="keywordSelectionStep">
          <div class="step-title">
            <span class="step-number">7</span>
            ÌÇ§ÏõåÎìú ÏÑ†ÌÉù
          </div>
          <p style="margin-bottom: 20px">
            ÏÑ†ÌÉùÌïú ÏΩîÏù∏Ïóê ÎßûÎäî ÌÇ§ÏõåÎìúÎ•º 3Í∞úÍπåÏßÄ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.
          </p>
          <div class="keyword-grid" id="keywordOptions">
            <!-- ÌÇ§ÏõåÎìú ÏòµÏÖòÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
          </div>
          <div class="btn-group" style="margin-top: 20px">
            <button
              class="btn secondary"
              onclick="goToPreviousStep('keywordSelectionStep')"
            >
              Ïù¥Ï†Ñ
            </button>
            <button
              class="btn"
              onclick="createCard()"
              id="createCardBtn"
              disabled
            >
              Ïπ¥Îìú ÏÉùÏÑ±ÌïòÍ∏∞
            </button>
          </div>
          <div id="keywordStatus" class="status" style="display: none"></div>
        </div>

        <!-- 8Îã®Í≥Ñ: ÏôÑÎ£å -->
        <div class="step" id="completeStep">
          <div class="step-title">
            <span class="step-number">8</span>
            Ïπ¥Îìú ÏÉùÏÑ± ÏôÑÎ£å!
          </div>
          <div class="final-card">
            <h2>üéâ Ïû•Ï†ê Ïπ¥ÎìúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!</h2>
            <div class="selected-items" id="finalCardInfo">
              <!-- ÏÉùÏÑ±Îêú Ïπ¥Îìú Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
            </div>
          </div>
          <div class="navigation">
            <button class="btn secondary" onclick="goHome()">
              ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
            </button>
            <button class="btn" onclick="restart()">Îã§Ïãú ÏãúÏûëÌïòÍ∏∞</button>
          </div>
        </div>

        <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="navigation" id="navigation" style="display: none">
          <button class="btn secondary" onclick="previousStep()" id="prevBtn">
            Ïù¥Ï†Ñ Îã®Í≥Ñ
          </button>
          <button class="btn" onclick="nextStep()" id="nextBtn">
            Îã§Ïùå Îã®Í≥Ñ
          </button>
        </div>
      </div>
    </div>

    <script>
      // Ï†ÑÏó≠ ÏÉÅÌÉú Í¥ÄÎ¶¨
      const state = {
        currentStep: 1,
        totalSteps: 8,
        accessToken: null,
        jwtToken: null,
        memberId: null,
        isNewMember: false,
        selectedFinderType: null,
        formId: null,
        selectedCoin: null,
        selectedKeyword: null,
        selectedKeywords: new Set(),
        createdCard: null,
        selectedProfileImage: null,
        coinsWithKeywords: [],
        diaryEntry: null,
        fromExperience: false, // ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞ÏóêÏÑú Ïò® Í≤ΩÏö∞ ÌëúÏãú
      };

      // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
      function updateProgress() {
        const progress = (state.currentStep / state.totalSteps) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
      }

      // Îã®Í≥Ñ ÌëúÏãú
      function showStep(stepId) {
        document
          .querySelectorAll(".step")
          .forEach((step) => step.classList.remove("active"));
        document.getElementById(stepId).classList.add("active");

        const stepNumber = {
          loginStep: 1,
          nicknameStep: 2,
          profileStep: 3,
          coinFinderStep: 4,
          diaryStep: 5,
          coinSelectionStep: 6,
          keywordSelectionStep: 7,
          completeStep: 8,
        };

        state.currentStep = stepNumber[stepId] || 1;
        updateProgress();
      }

      // ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
      function showStatus(elementId, message, isError = false) {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.textContent = message;
        element.className = `status ${isError ? "error" : "success"}`;
      }

      // Ïù¥Ï†Ñ Îã®Í≥ÑÎ°ú Í∞ÄÍ∏∞
      function goToPreviousStep(currentStep) {
        const stepFlow = {
          nicknameStep: "loginStep",
          profileStep: "nicknameStep",
          coinFinderStep: state.isNewMember ? "profileStep" : "loginStep",
          diaryStep: "coinFinderStep",
          coinSelectionStep: "diaryStep",
          keywordSelectionStep: "coinSelectionStep",
        };

        const previousStep = stepFlow[currentStep];
        if (previousStep) {
          showStep(previousStep);

          // ÌäπÎ≥ÑÌïú Ï≤òÎ¶¨Í∞Ä ÌïÑÏöîÌïú Í≤ΩÏö∞
          if (previousStep === "coinFinderStep") {
            loadFinderTypes();
          } else if (previousStep === "profileStep") {
            loadProfileImages();
          }
        }
      }

      // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
      function showLoading(elementId, message = "Ï≤òÎ¶¨ Ï§ë...") {
        const element = document.getElementById(elementId);
        element.style.display = "block";
        element.innerHTML = `<span class="loading"></span> ${message}`;
        element.className = "status";
      }

      // 1. Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏
      async function startKakaoLogin() {
        showLoading("loginStatus", "Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô Ï§ë...");

        try {
          // ÌîåÎ°úÏö∞ ÌÖåÏä§Ìä∏ÏûÑÏùÑ ÏïåÎ¶¨Îäî ÌååÎùºÎØ∏ÌÑ∞ÏôÄ Ìï®Íªò Ïπ¥Ïπ¥Ïò§ Ïù∏Ï¶ù URLÏùÑ Í∞ÄÏ†∏Ïò¥
          const response = await fetch("/auth/kakao/url?from_flow=true");
          const data = await response.json();

          if (data.success && data.data) {
            // Ïã§Ï†ú Ïπ¥Ïπ¥Ïò§ Ïù∏Ï¶ù ÌéòÏù¥ÏßÄÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏
            window.location.href = data.data;
          } else {
            showStatus(
              "loginStatus",
              "Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ URLÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.",
              true
            );
          }
        } catch (error) {
          showStatus(
            "loginStatus",
            "Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Ï§ÄÎπÑ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
            true
          );
        }
      }

      // Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Í≤∞Í≥º Ï≤òÎ¶¨ Ìï®Ïàò
      function handleKakaoLoginResult(urlParams) {
        try {
          showStatus("loginStatus", "Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ! Îã§Ïùå Îã®Í≥ÑÎ°ú ÏßÑÌñâÌï©ÎãàÎã§.");

          const accessToken = urlParams.get("access_token");
          const memberId = urlParams.get("member_id");
          const token = urlParams.get("token");
          const isNewMember = urlParams.get("is_new_member");
          const isExisting = urlParams.get("is_existing");

          // URL ÌååÎùºÎØ∏ÌÑ∞Î•º ÏïàÏ†ÑÌïòÍ≤å booleanÏúºÎ°ú Î≥ÄÌôò
          const isNewMemberBool = isNewMember === "true";
          const isExistingBool = isExisting === "true";

          console.log("Login result parameters:", {
            isNewMember,
            isExisting,
            isNewMemberBool,
            isExistingBool,
            accessToken,
            memberId,
            token,
            "accessToken length": accessToken ? accessToken.length : 0,
            "memberId type": typeof memberId,
            "token length": token ? token.length : 0,
          });

          if (isNewMemberBool) {
            // Ïã†Í∑ú ÌöåÏõêÏù∏ Í≤ΩÏö∞
            console.log("Processing new member flow");
            state.isNewMember = true;
            state.accessToken = accessToken;
            console.log("New member flow - going to nickname step");
            setTimeout(() => {
              showStep("nicknameStep");
            }, 1000);
          } else if (isExistingBool) {
            // Í∏∞Ï°¥ ÌöåÏõêÏù∏ Í≤ΩÏö∞
            console.log("Processing existing member flow");
            state.isNewMember = false;
            state.memberId = memberId;
            state.jwtToken = token;

            console.log("Existing member flow", {
              skipToCoins: state.skipToCoins,
              fromExperience: state.fromExperience,
            });

            // ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞ÏóêÏÑú Ïò® Í≤ΩÏö∞ Î∞îÎ°ú ÏΩîÏù∏ ÏÑ†ÌÉùÏúºÎ°ú Ïù¥Îèô
            if (state.skipToCoins && state.fromExperience) {
              console.log("Skipping to coins for experience flow");
              setTimeout(() => {
                loadCoins();
                showStep("coinSelectionStep");
              }, 1000);
            } else {
              // ÏùºÎ∞òÏ†ÅÏù∏ Í≤ΩÏö∞ ÏΩîÏù∏ Ï∞æÍ∏∞ Îã®Í≥ÑÎ°ú Ïù¥Îèô
              console.log("Going to finder types step");
              setTimeout(() => {
                showStep("coinFinderStep");
                loadFinderTypes();
              }, 1000);
            }
          } else {
            // ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞Ïùò Ï≤òÎ¶¨
            console.error("No valid login parameters found:", {
              isNewMember,
              isExisting,
              isNewMemberBool,
              isExistingBool,
            });
            showStatus(
              "loginStatus",
              "Î°úÍ∑∏Ïù∏ Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÌååÎùºÎØ∏ÌÑ∞: isNewMember=" +
                isNewMember +
                ", isExisting=" +
                isExisting,
              true
            );
          }

          // URLÏóêÏÑú ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞ (Îí§Î°úÍ∞ÄÍ∏∞ Îì±ÏùÑ ÏúÑÌï¥)
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          );
        } catch (error) {
          console.error("Error in handleKakaoLoginResult:", error);
          showStatus(
            "loginStatus",
            "Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
            true
          );
        }
      }

      // 2. ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï
      async function setNickname() {
        const nickname = document.getElementById("nickname").value.trim();
        if (!nickname) {
          showStatus("nicknameStatus", "ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", true);
          return;
        }

        if (nickname.length < 2 || nickname.length > 10) {
          showStatus("nicknameStatus", "ÎãâÎÑ§ÏûÑÏùÄ 2-10ÏûêÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", true);
          return;
        }

        showLoading("nicknameStatus", "ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï Ï§ë...");

        try {
          const response = await fetch("/signup/nickname", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              accessToken: state.accessToken,
              nickname: nickname,
            }),
          });

          const data = await response.json();
          if (data.success) {
            showStatus("nicknameStatus", "ÎãâÎÑ§ÏûÑÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.");
            loadProfileImages();
            showStep("profileStep");
          } else {
            showStatus(
              "nicknameStatus",
              data.message || "ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
              true
            );
          }
        } catch (error) {
          showStatus("nicknameStatus", "ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", true);
        }
      }

      // 3. ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ Î°úÎìú Î∞è ÏÑ†ÌÉù
      function loadProfileImages() {
        const profileImages = [
          "https://via.placeholder.com/80/667eea/white?text=üòä",
          "https://via.placeholder.com/80/764ba2/white?text=üòé",
          "https://via.placeholder.com/80/f093fb/white?text=üåü",
          "https://via.placeholder.com/80/4facfe/white?text=üöÄ",
          "https://via.placeholder.com/80/43e97b/white?text=üéØ",
          "https://via.placeholder.com/80/f38ba8/white?text=üíé",
        ];

        const container = document.getElementById("profileImages");
        container.innerHTML = "";

        profileImages.forEach((imageUrl, index) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <img src="${imageUrl}" alt="ÌîÑÎ°úÌïÑ ${
            index + 1
          }" style="width: 80px; height: 80px; margin: 0 auto; display: block; border-radius: 50%;">
            <p style="text-align: center; margin-top: 10px;">ÌîÑÎ°úÌïÑ ${
              index + 1
            }</p>
          `;
          card.addEventListener("click", () =>
            selectProfileImage(imageUrl, card)
          );
          container.appendChild(card);
        });
      }

      function selectProfileImage(imageUrl, element) {
        document
          .querySelectorAll("#profileImages .card")
          .forEach((card) => card.classList.remove("selected"));
        element.classList.add("selected");
        state.selectedProfileImage = imageUrl;
        document.getElementById("profileBtn").disabled = false;
      }

      async function setProfileImage() {
        if (!state.selectedProfileImage) {
          showStatus("profileStatus", "ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.", true);
          return;
        }

        showLoading("profileStatus", "ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï Ï§ë...");

        try {
          const response = await fetch("/signup/profile-image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              accessToken: state.accessToken,
              profileImage: state.selectedProfileImage,
            }),
          });

          const data = await response.json();
          if (data.success) {
            state.jwtToken = data.data.token || "temp_jwt_" + Date.now();
            showStatus("profileStatus", "ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§.");

            // ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞ÏóêÏÑú Ïò® Í≤ΩÏö∞ Î∞îÎ°ú ÏΩîÏù∏ ÏÑ†ÌÉùÏúºÎ°ú Ïù¥Îèô
            if (state.skipToCoins && state.fromExperience) {
              loadCoins();
              showStep("coinSelectionStep");
            } else {
              // ÏùºÎ∞òÏ†ÅÏù∏ Í≤ΩÏö∞ ÏΩîÏù∏ Ï∞æÍ∏∞ Îã®Í≥ÑÎ°ú Ïù¥Îèô
              loadFinderTypes();
              showStep("coinFinderStep");
            }
          } else {
            showStatus(
              "profileStatus",
              data.message || "ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
              true
            );
          }
        } catch (error) {
          showStatus("profileStatus", "ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", true);
        }
      }

      // 4. ÏΩîÏù∏ Ï∞æÍ∏∞ Ïú†Ìòï Î°úÎìú
      async function loadFinderTypes() {
        try {
          const response = await fetch("/api/coin-finder/types");
          const data = await response.json();

          if (data.success) {
            const container = document.getElementById("finderTypes");
            container.innerHTML = "";

            // ÎÇòÏùò Ïû•Ï†ê ÏΩîÏù∏
            data.data.myStrengthCoins.forEach((type) => {
              const card = document.createElement("div");
              card.className = "card";

              if (type.type === "EXPERIENCE_REFLECTION") {
                // ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞Îäî Î≥ÑÎèÑ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                card.innerHTML = `
                  <h3>${type.title}</h3>
                  <p>${type.description}</p>
                  <small style="color: #667eea; font-weight: 500;">${type.category}</small>
                `;
                card.addEventListener("click", () => {
                  window.location.href = "/situation-context-selection";
                });
              } else {
                card.innerHTML = `
                  <h3>${type.title}</h3>
                  <p>${type.description}</p>
                  <small style="color: #667eea; font-weight: 500;">${type.category}</small>
                `;
                card.addEventListener("click", () =>
                  selectFinderType(type, card)
                );
              }

              container.appendChild(card);
            });

            // ÏπúÍµ¨Ïùò Ïû•Ï†ê ÏΩîÏù∏ (ÏùºÎã® ÎπÑÌôúÏÑ±Ìôî)
            data.data.friendStrengthCoins.forEach((type) => {
              const card = document.createElement("div");
              card.className = "card";
              card.style.opacity = "0.6";
              card.style.cursor = "not-allowed";
              card.innerHTML = `
                <h3>${type.title}</h3>
                <p>${type.description}</p>
                <small style="color: #999;">ÌòÑÏû¨ ÌÖåÏä§Ìä∏ÏóêÏÑúÎäî ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§</small>
              `;
              container.appendChild(card);
            });
          }
        } catch (error) {
          showStatus(
            "finderStatus",
            "ÏΩîÏù∏ Ï∞æÍ∏∞ Ïú†ÌòïÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
            true
          );
        }
      }

      function selectFinderType(type, element) {
        if (type.type !== "TODAY_DIARY") {
          showStatus(
            "finderStatus",
            'ÌòÑÏû¨ ÌÖåÏä§Ìä∏ÏóêÏÑúÎäî "Ïò§ÎäòÏùò ÏùºÍ∏∞"Îßå ÏßÄÏõêÌï©ÎãàÎã§.',
            true
          );
          return;
        }

        document
          .querySelectorAll("#finderTypes .card")
          .forEach((card) => card.classList.remove("selected"));
        element.classList.add("selected");
        state.selectedFinderType = type;

        showStatus("finderStatus", "ÏÑ†ÌÉùÏôÑÎ£å! Ïò§ÎäòÏùò ÏùºÍ∏∞Î•º ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.");
        setTimeout(() => {
          showStep("diaryStep");
        }, 1000);
      }

      // 5. ÏùºÍ∏∞ Ï†ÄÏû•
      async function saveDiary() {
        const content = document.getElementById("diaryContent").value.trim();
        if (!content) {
          showStatus("diaryStatus", "ÏùºÍ∏∞ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", true);
          return;
        }

        showLoading("diaryStatus", "ÏùºÍ∏∞ Ï†ÄÏû• Ï§ë...");

        try {
          const response = await fetch("/api/coin-finder/daily-diary", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content }),
          });

          const data = await response.json();
          if (data.success) {
            state.formId = data.data.formId;
            showStatus(
              "diaryStatus",
              "ÏùºÍ∏∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! Ïù¥Ï†ú ÏΩîÏù∏ÏùÑ ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî."
            );
            setTimeout(() => {
              loadCoins();
              showStep("coinSelectionStep");
            }, 1000);
          } else {
            showStatus(
              "diaryStatus",
              data.message || "ÏùºÍ∏∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
              true
            );
          }
        } catch (error) {
          showStatus("diaryStatus", "ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", true);
        }
      }

      // 6. ÏΩîÏù∏ Î∞è ÌÇ§ÏõåÎìú Î°úÎìúÏôÄ ÏÑ†ÌÉù (ÏÉàÎ°úÏö¥ UI)
      async function loadCoins() {
        showLoading("coinSelectionStatus", "Ïû•Ï†ê Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...");
        try {
          const response = await fetch("/api/coin-finder/selection-options");
          const data = await response.json();

          if (data.success && data.data && data.data.coins) {
            state.coinsWithKeywords = Object.values(data.data.coins);

            // 6Îã®Í≥Ñ UIÎ•º ÏÉàÎ°úÏö¥ ÌòïÌÉúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            const container = document.getElementById("coinSelectionStep");
            container.innerHTML = `
              <div class="step-title">
                <span class="step-number">6</span>
                Í∑∏Îïå Ïñ¥Îñ§ Ïû•Ï†êÏù¥ ÎìúÎü¨ÎÇ¨ÎÇòÏöî?
              </div>
              <p style="margin-bottom: 20px; color: #666;">Í∞ÄÏû• ÎèãÎ≥¥ÏòÄÎã§Í≥† ÏÉùÍ∞ÅÌïòÎäî Ïû•Ï†ê ÌïòÎÇòÎßå Í≥®ÎùºÏ£ºÏÑ∏Ïöî.</p>
              
              <div id="coin-categories" class="categories"></div>
              <div id="keyword-grid" class="keyword-grid"></div>
              
              <div class="btn-group" style="margin-top: 20px">
                <button class="btn secondary" onclick="goToPreviousStep('coinSelectionStep')">Ïù¥Ï†Ñ</button>
                <button id="selectKeywordBtn" class="btn" onclick="goToNextStep()" disabled>Îã§Ïùå</button>
              </div>
              <div id="coinSelectionStatus" class="status" style="display: none"></div>
            `;

            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ ÏÉùÏÑ±
            const categoriesContainer =
              document.getElementById("coin-categories");
            state.coinsWithKeywords.forEach((coin, index) => {
              const categoryBtn = document.createElement("button");
              categoryBtn.className = "category-btn";
              categoryBtn.textContent = coin.name;
              categoryBtn.onclick = () => selectCategory(coin, categoryBtn);
              categoriesContainer.appendChild(categoryBtn);

              // Ï≤´ Î≤àÏß∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í∏∞Î≥∏ ÏÑ†ÌÉù
              if (index === 0) {
                setTimeout(() => categoryBtn.click(), 100);
              }
            });

            showStatus("coinSelectionStatus", "");
          } else {
            showStatus(
              "coinSelectionStatus",
              "ÏΩîÏù∏ ÏòµÏÖòÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: " + (data.message || ""),
              true
            );
          }
        } catch (error) {
          showStatus(
            "coinSelectionStatus",
            "ÏΩîÏù∏ ÏòµÏÖòÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
            true
          );
        }
      }

      function selectCategory(coin, btnElement) {
        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document
          .querySelectorAll(".category-btn")
          .forEach((btn) => btn.classList.remove("selected"));
        btnElement.classList.add("selected");

        state.selectedCoin = coin;
        state.selectedKeyword = null;
        document.getElementById("selectKeywordBtn").disabled = true;

        // ÌÇ§ÏõåÎìú Í∑∏Î¶¨Îìú ÏóÖÎç∞Ïù¥Ìä∏
        const keywordGrid = document.getElementById("keyword-grid");
        keywordGrid.innerHTML = "";

        coin.keywords.forEach((keyword) => {
          const keywordCard = document.createElement("div");
          keywordCard.className = "keyword-card";
          keywordCard.textContent = keyword.name;
          keywordCard.onclick = () => selectKeyword(keyword, keywordCard);
          keywordGrid.appendChild(keywordCard);
        });
      }

      function selectKeyword(keyword, cardElement) {
        // ÌÇ§ÏõåÎìú Ïπ¥Îìú ÏÑ†ÌÉù ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document
          .querySelectorAll(".keyword-card")
          .forEach((card) => card.classList.remove("selected"));
        cardElement.classList.add("selected");

        state.selectedKeyword = keyword;
        document.getElementById("selectKeywordBtn").disabled = false;
        showStatus(
          "coinSelectionStatus",
          `Ïû•Ï†ê "${keyword.name}"Ïù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`
        );
      }

      function goToNextStep() {
        if (!state.selectedKeyword) {
          showStatus("coinSelectionStatus", "Î®ºÏ†Ä Ïû•Ï†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.", true);
          return;
        }

        // ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•ÌïòÍ≥† Îã§Ïùå Îã®Í≥ÑÎ°ú
        console.log(
          `ÏÑ†ÌÉùÎêú ÏΩîÏù∏: ${state.selectedCoin.name}, ÏÑ†ÌÉùÎêú ÌÇ§ÏõåÎìú: ${state.selectedKeyword.name}`
        );

        // ÌÇ§ÏõåÎìú ÏÑ†ÌÉù Îã®Í≥ÑÎäî Í±¥ÎÑàÎõ∞Í≥† Î∞îÎ°ú Ïπ¥Îìú ÏÉùÏÑ±ÏúºÎ°ú
        showStep("keywordSelectionStep");
        prepareCardCreation();
      }

      // Ïπ¥Îìú ÏÉùÏÑ± Ï§ÄÎπÑ Ìï®Ïàò
      function prepareCardCreation() {
        const container = document.getElementById("keywordSelectionStep");
        container.innerHTML = `
          <div class="step-title">
            <span class="step-number">7</span>
            ÏÑ†ÌÉùÌïú Ïû•Ï†êÏúºÎ°ú Ïπ¥ÎìúÎ•º ÎßåÎì§ÍπåÏöî?
          </div>
          
          <div class="summary-box">
            <p><strong>Í≤ΩÌóò:</strong> ${
              document.getElementById("diaryContent")
                ? document.getElementById("diaryContent").value
                : state.diaryEntry || "Ïò§ÎäòÏùò ÏùºÍ∏∞"
            }</p>
            <p><strong>Ïû•Ï†ê Ïπ¥ÌÖåÍ≥†Î¶¨:</strong> ${state.selectedCoin.name}</p>
            <p><strong>Í∞ÄÏû• ÎπõÎÇú Ïû•Ï†ê:</strong> ${
              state.selectedKeyword.name
            }</p>
          </div>
          
          <div class="btn-group" style="margin-top: 20px">
            <button class="btn secondary" onclick="goToPreviousStep('keywordSelectionStep')">Ïù¥Ï†Ñ</button>
            <button class="btn" onclick="createCard()">ÎÑ§, ÎßåÎì§ÎûòÏöî</button>
          </div>
          <div id="keywordStatus" class="status" style="display: none"></div>
        `;
      }

      // 7. ÌÇ§ÏõåÎìú Î°úÎìú Î∞è ÏÑ†ÌÉù
      function loadKeywords() {
        if (!state.selectedCoin) return;

        const container = document.getElementById("keywordOptions");
        container.innerHTML = "";

        state.selectedCoin.keywords.forEach((keyword) => {
          const tag = document.createElement("div");
          tag.className = "keyword-tag";
          tag.textContent = keyword.name;
          tag.addEventListener("click", () => toggleKeyword(keyword, tag));
          container.appendChild(tag);
        });
      }

      function toggleKeyword(keyword, element) {
        if (state.selectedKeywords.has(keyword.id)) {
          state.selectedKeywords.delete(keyword.id);
          element.classList.remove("selected");
        } else {
          if (state.selectedKeywords.size < 3) {
            state.selectedKeywords.add(keyword.id);
            element.classList.add("selected");
          } else {
            showStatus(
              "keywordStatus",
              "ÏµúÎåÄ 3Í∞úÏùò ÌÇ§ÏõåÎìúÎßå ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.",
              true
            );
            return;
          }
        }

        const selectedCount = state.selectedKeywords.size;
        document.getElementById("createCardBtn").disabled = selectedCount === 0;

        if (selectedCount > 0) {
          showStatus(
            "keywordStatus",
            `${selectedCount}Í∞úÏùò ÌÇ§ÏõåÎìúÍ∞Ä ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.`
          );
        }
      }

      // 8. Ïπ¥Îìú ÏÉùÏÑ±
      async function createCard() {
        if (!state.selectedKeyword) {
          showStatus("keywordStatus", "ÌÇ§ÏõåÎìúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.", true);
          return;
        }

        showLoading("keywordStatus", "Ïπ¥Îìú ÏÉùÏÑ± Ï§ë...");

        try {
          const response = await fetch("/api/cards", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              formId: state.formId,
              coinId: state.selectedCoin.id,
              keywordIds: [state.selectedKeyword.id],
            }),
          });

          const result = await response.json();
          if (result.success) {
            state.createdCard = result.data;
            showCardComplete();
            showStep("completeStep");
          } else {
            showStatus(
              "keywordStatus",
              result.message || "Ïπ¥Îìú ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
              true
            );
          }
        } catch (error) {
          showStatus("keywordStatus", "ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", true);
        }
      }

      // ÏôÑÎ£å Ï†ïÎ≥¥ ÌëúÏãú
      function showCardComplete() {
        const container = document.getElementById("finalCardInfo");

        container.innerHTML = `
          <div style="text-align: left;">
            <h2>üéâ Ïπ¥Îìú ÏôÑÏÑ±!</h2>
            <p>ÎÇòÏùò Í≤ΩÌóòÏù¥ Î©ãÏßÑ Ïπ¥ÎìúÎ°ú ÎßåÎì§Ïñ¥Ï°åÏñ¥Ïöî.</p>
            <div class="summary-box">
              <h3>${state.selectedCoin.name}</h3>
              <p><strong>${state.selectedKeyword.name}</strong></p>
              <p style="margin-top: 1rem; color: #555;">${
                document.getElementById("diaryContent")
                  ? document.getElementById("diaryContent").value
                  : state.diaryEntry || "Ïò§ÎäòÏùò ÏùºÍ∏∞"
              }</p>
            </div>
            ${
              state.createdCard
                ? `<p>ÏÉùÏÑ±Îêú Ïπ¥Îìú ID: ${state.createdCard.id}</p>`
                : ""
            }
          </div>
        `;
      }

      // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
      function goHome() {
        window.location.href = "/";
      }

      function restart() {
        // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        Object.keys(state).forEach((key) => {
          if (key === "selectedKeywords") {
            state[key] = new Set();
          } else if (typeof state[key] === "number") {
            state[key] =
              key === "currentStep" ? 1 : key === "totalSteps" ? 8 : null;
          } else {
            state[key] = null;
          }
        });

        // URL Ï†ïÎ¶¨
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );

        // Ï≤´ Î≤àÏß∏ Îã®Í≥ÑÎ°ú Ïù¥Îèô
        showStep("loginStep");

        // Î™®Îì† ÏÉÅÌÉú Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
        document
          .querySelectorAll(".status")
          .forEach((el) => (el.style.display = "none"));

        // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        document.getElementById("nickname").value = "";
        document.getElementById("diaryContent").value = "";
      }

      // Ï¥àÍ∏∞Ìôî
      function initializeApp() {
        // URL ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏
        const urlParams = new URLSearchParams(window.location.search);

        // Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏ Í≤∞Í≥º Ï≤òÎ¶¨
        const loginSuccess = urlParams.get("login_success");
        if (loginSuccess === "true") {
          handleKakaoLoginResult(urlParams);
          return; // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ ÌõÑ Ï¢ÖÎ£å
        }

        // ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞ÏóêÏÑú Ïò® Í≤ΩÏö∞ Ï≤òÎ¶¨
        const formId = urlParams.get("formId");
        const type = urlParams.get("type");
        const fromExperience = urlParams.get("from_experience");

        if (
          formId &&
          type === "EXPERIENCE_REFLECTION" &&
          fromExperience === "true"
        ) {
          // ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞ÏóêÏÑú Ïò® Í≤ΩÏö∞
          state.formId = parseInt(formId);
          state.fromExperience = true;
          state.selectedFinderType = { type: "EXPERIENCE_REFLECTION" };

          // Ïπ¥Ïπ¥Ïò§ Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïòÎØÄÎ°ú Ï≤´ Î≤àÏß∏ Îã®Í≥ÑÎ∂ÄÌÑ∞ ÏãúÏûë
          showStep("loginStep");

          // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
          showStatus(
            "loginStatus",
            "ÏÇ¨Î°Ä ÎèåÏïÑÎ≥¥Í∏∞Î•º ÏôÑÎ£åÌñàÏäµÎãàÎã§! Ïù¥Ï†ú Î°úÍ∑∏Ïù∏ ÌõÑ Ïû•Ï†êÏùÑ ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî."
          );

          // ÏûêÎèôÏúºÎ°ú Îã§Ïùå Îã®Í≥ÑÎì§ÏùÑ Í±¥ÎÑàÎõ∞Í≥† ÏΩîÏù∏ ÏÑ†ÌÉùÏúºÎ°ú Î∞îÎ°ú Ïù¥ÎèôÌï† Ïàò ÏûàÎèÑÎ°ù Ï§ÄÎπÑ
          state.skipToCoins = true;
        } else {
          // ÏùºÎ∞òÏ†ÅÏù∏ ÌîåÎ°úÏö∞
          showStep("loginStep");
        }

        updateProgress();
      }

      // Ïï± Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
      initializeApp();
    </script>
  </body>
</html>
