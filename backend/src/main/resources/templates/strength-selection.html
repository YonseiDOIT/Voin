<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>장점 선택 - VOIN</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        min-height: calc(100vh - 40px);
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .content {
        padding: 40px;
      }

      .step-section {
        margin-bottom: 40px;
      }

      .step-title {
        font-size: 1.6em;
        margin-bottom: 20px;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .step-number {
        background: #667eea;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        font-weight: bold;
      }

      .step-description {
        color: #6c757d;
        font-size: 1.1em;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .progress-container {
        margin-bottom: 30px;
      }

      .progress-text {
        text-align: center;
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 10px;
      }

      .progress-bar {
        background: #e9ecef;
        border-radius: 50px;
        height: 8px;
      }

      .progress-fill {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50px;
        height: 100%;
        transition: width 0.3s ease;
        width: 0%;
      }

      /* 카테고리 선택 스타일 */
      .categories {
        display: flex;
        gap: 12px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .category-btn {
        padding: 12px 20px;
        border-radius: 25px;
        border: 2px solid #e9ecef;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1em;
        font-weight: 500;
      }

      .category-btn:hover {
        border-color: #667eea;
        background-color: #f0f4ff;
        transform: translateY(-2px);
      }

      .category-btn.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
      }

      /* 키워드 그리드 스타일 */
      .keyword-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .keyword-card {
        background-color: white;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        font-size: 1em;
        font-weight: 500;
        min-height: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }

      .keyword-card:hover {
        border-color: #667eea;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        transform: translateY(-3px);
      }

      .keyword-card.selected {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
      }

      .keyword-card.selected::before {
        content: "✓";
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 1.2em;
        font-weight: bold;
      }

      /* 요약 박스 스타일 */
      .summary-box {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        border-radius: 0 12px 12px 0;
        padding: 25px;
        margin: 30px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .summary-box h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 1.2em;
      }

      .summary-box p {
        margin: 10px 0;
        line-height: 1.6;
        color: #495057;
      }

      .summary-box strong {
        color: #333;
      }

      /* 버튼 스타일 */
      .btn {
        display: inline-block;
        padding: 15px 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        font-size: 1em;
        text-align: center;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.secondary:hover {
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 40px;
      }

      /* 알림 스타일 */
      .alert {
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-weight: 500;
        text-align: center;
      }

      .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* 로딩 스타일 */
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 단계별 표시 */
      .step {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .step.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 카드 완료 스타일 */
      .final-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 20px;
        margin: 30px 0;
        text-align: center;
      }

      .final-card h2 {
        margin-bottom: 20px;
        font-size: 1.8em;
      }

      .selected-items {
        background: white;
        color: #333;
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        text-align: left;
      }

      @media (max-width: 768px) {
        .content {
          padding: 30px 20px;
        }

        .categories {
          flex-direction: column;
          align-items: stretch;
        }

        .category-btn {
          text-align: center;
        }

        .keyword-grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 15px;
        }

        .btn-group {
          flex-direction: column;
          align-items: center;
        }

        .btn {
          width: 100%;
          max-width: 300px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>⭐ 장점 선택</h1>
        <p>당신의 경험에서 가장 빛났던 장점을 선택해보세요</p>
      </div>

      <div class="content">
        <!-- 진행률 표시 -->
        <div class="progress-container">
          <div class="progress-text">
            단계 <span id="currentStepText">1</span>/3
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <!-- 1단계: 코인 카테고리 및 키워드 선택 -->
        <div class="step active" id="selectionStep">
          <div class="step-section">
            <div class="step-title">
              <span class="step-number">1</span>
              어떤 장점이 가장 돋보였나요?
            </div>
            <div class="step-description">
              먼저 장점 카테고리를 선택한 후, 가장 돋보였다고 생각하는 구체적인
              장점을 하나 골라주세요.
            </div>

            <!-- 카테고리 선택 -->
            <div id="coin-categories" class="categories">
              <!-- 동적으로 생성됩니다 -->
            </div>

            <!-- 키워드 선택 -->
            <div id="keyword-grid" class="keyword-grid">
              <!-- 동적으로 생성됩니다 -->
            </div>

            <div id="selectionAlert"></div>

            <div class="btn-group">
              <a href="/" class="btn secondary">홈으로</a>
              <button id="nextBtn" class="btn" onclick="goToSummary()" disabled>
                선택 완료 →
              </button>
            </div>
          </div>
        </div>

        <!-- 2단계: 선택 확인 및 요약 -->
        <div class="step" id="summaryStep">
          <div class="step-section">
            <div class="step-title">
              <span class="step-number">2</span>
              선택한 내용을 확인해주세요
            </div>
            <div class="step-description">
              아래 내용으로 장점 카드를 생성할까요?
            </div>

            <div class="summary-box" id="summaryContent">
              <!-- 동적으로 생성됩니다 -->
            </div>

            <div id="summaryAlert"></div>

            <div class="btn-group">
              <button class="btn secondary" onclick="goBackToSelection()">
                다시 선택하기
              </button>
              <button class="btn" onclick="createCard()">
                장점 카드 생성하기
              </button>
            </div>
          </div>
        </div>

        <!-- 3단계: 완료 -->
        <div class="step" id="completeStep">
          <div class="step-section">
            <div class="step-title">
              <span class="step-number">3</span>
              장점 카드 생성 완료!
            </div>

            <div class="final-card">
              <h2>🎉 장점 카드가 생성되었습니다!</h2>
              <div class="selected-items" id="finalCardInfo">
                <!-- 생성된 카드 정보가 여기에 표시됩니다 -->
              </div>
            </div>

            <div class="btn-group">
              <a href="/" class="btn secondary">홈으로</a>
              <a href="/cards" class="btn">내 코인 보기</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 전역 상태 관리
      const state = {
        currentStep: 1,
        totalSteps: 3,
        selectedCoin: null,
        selectedKeyword: null,
        coinsWithKeywords: [],
        formData: null,
        createdCard: null,
      };

      // 페이지 초기화
      async function initializePage() {
        // 로그인 상태 확인
        const isLoggedIn = await checkLoginStatus();
        if (!isLoggedIn) {
          showAlert(
            "selectionAlert",
            "로그인이 필요합니다. 홈페이지로 이동합니다.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/";
          }, 2000);
          return;
        }

        // Form 데이터 확인
        const formId = localStorage.getItem("currentFormId");
        if (!formId) {
          showAlert(
            "selectionAlert",
            "이전 단계를 먼저 완료해주세요. 홈페이지로 이동합니다.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/";
          }, 2000);
          return;
        }

        loadFormData(formId);
        loadCoins();
        updateProgress();
      }

      // 로그인 상태 확인
      async function checkLoginStatus() {
        const loginData = localStorage.getItem("voin_login");
        if (!loginData) {
          return false;
        }

        try {
          const user = JSON.parse(loginData);
          // 토큰이 유효한지 서버에서 간단히 확인
          // 현재는 localStorage 데이터가 있으면 로그인된 것으로 처리
          return true;
        } catch (e) {
          localStorage.removeItem("voin_login");
          return false;
        }
      }

      // Form 데이터 로드
      async function loadFormData(formId) {
        try {
          const loginData = JSON.parse(localStorage.getItem("voin_login"));
          const response = await fetch(`/api/coin-finder/forms/${formId}`, {
            headers: {
              Authorization: `Bearer ${loginData.token}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            state.formData = result.data;
          } else {
            console.warn("Form 데이터를 불러올 수 없습니다.");
          }
        } catch (error) {
          console.error("Form 데이터 로드 실패:", error);
        }
      }

      // 코인 데이터 로드
      async function loadCoins() {
        try {
          showLoading("selectionAlert", "장점 목록을 불러오는 중...");

          const response = await fetch("/api/coin-finder/selection-options");
          const data = await response.json();

          if (data.success && data.data && data.data.coins) {
            // coins 객체를 배열로 변환
            state.coinsWithKeywords = Object.values(data.data.coins);
            renderCategories();
            hideAlert("selectionAlert");
          } else {
            showAlert(
              "selectionAlert",
              "장점 목록을 불러오는데 실패했습니다.",
              "error"
            );
          }
        } catch (error) {
          showAlert(
            "selectionAlert",
            "장점 목록을 불러오는데 실패했습니다.",
            "error"
          );
        }
      }

      // 카테고리 렌더링
      function renderCategories() {
        const categoriesContainer = document.getElementById("coin-categories");
        categoriesContainer.innerHTML = "";

        state.coinsWithKeywords.forEach((coin, index) => {
          const categoryBtn = document.createElement("button");
          categoryBtn.className = "category-btn";
          categoryBtn.textContent = coin.name;
          categoryBtn.onclick = () => selectCategory(coin, categoryBtn);
          categoriesContainer.appendChild(categoryBtn);

          // 첫 번째 카테고리를 기본 선택
          if (index === 0) {
            setTimeout(() => categoryBtn.click(), 100);
          }
        });
      }

      // 카테고리 선택
      function selectCategory(coin, btnElement) {
        // 카테고리 버튼 상태 업데이트
        document
          .querySelectorAll(".category-btn")
          .forEach((btn) => btn.classList.remove("selected"));
        btnElement.classList.add("selected");

        state.selectedCoin = coin;
        state.selectedKeyword = null;
        document.getElementById("nextBtn").disabled = true;

        // 키워드 그리드 업데이트
        renderKeywords(coin.keywords);
      }

      // 키워드 렌더링
      function renderKeywords(keywords) {
        const keywordGrid = document.getElementById("keyword-grid");
        keywordGrid.innerHTML = "";

        keywords.forEach((keyword) => {
          const keywordCard = document.createElement("div");
          keywordCard.className = "keyword-card";
          keywordCard.textContent = keyword.name;
          keywordCard.onclick = () => selectKeyword(keyword, keywordCard);
          keywordGrid.appendChild(keywordCard);
        });
      }

      // 키워드 선택
      function selectKeyword(keyword, cardElement) {
        // 키워드 카드 상태 업데이트
        document
          .querySelectorAll(".keyword-card")
          .forEach((card) => card.classList.remove("selected"));
        cardElement.classList.add("selected");

        state.selectedKeyword = keyword;
        document.getElementById("nextBtn").disabled = false;

        showAlert(
          "selectionAlert",
          `"${keyword.name}" 장점이 선택되었습니다.`,
          "success"
        );
      }

      // 요약 단계로 이동
      function goToSummary() {
        if (!state.selectedKeyword) {
          showAlert("selectionAlert", "먼저 장점을 선택해주세요.", "error");
          return;
        }

        showStep("summaryStep");
        renderSummary();
      }

      // 요약 렌더링
      function renderSummary() {
        const summaryContent = document.getElementById("summaryContent");

        let experienceText = "경험 내용";
        if (state.formData) {
          if (state.formData.type === "TODAY_DIARY") {
            experienceText = state.formData.description || "오늘의 일기";
          } else if (state.formData.type === "EXPERIENCE_REFLECTION") {
            experienceText = state.formData.description || "사례 돌아보기";
          }
        }

        summaryContent.innerHTML = `
                <h3>선택된 내용</h3>
                <p><strong>경험:</strong> ${experienceText}</p>
                <p><strong>장점 카테고리:</strong> ${state.selectedCoin.name}</p>
                <p><strong>선택한 장점:</strong> ${state.selectedKeyword.name}</p>
            `;
      }

      // 선택으로 돌아가기
      function goBackToSelection() {
        showStep("selectionStep");
      }

      // 카드 생성
      async function createCard() {
        try {
          showLoading("summaryAlert", "장점 카드를 생성하는 중...");

          const loginData = JSON.parse(localStorage.getItem("voin_login"));
          const formId = localStorage.getItem("currentFormId");

          const cardData = {
            formId: parseInt(formId),
            coinId: state.selectedCoin.id,
            keywordIds: [state.selectedKeyword.id],
          };

          const response = await fetch("/api/cards", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${loginData.token}`,
            },
            body: JSON.stringify(cardData),
          });

          if (response.ok) {
            const result = await response.json();
            state.createdCard = result.data;

            // 임시 Form ID 정리
            localStorage.removeItem("currentFormId");

            showStep("completeStep");
            renderFinalCard();
          } else {
            const errorData = await response.json();
            showAlert(
              "summaryAlert",
              "카드 생성에 실패했습니다: " + (errorData.message || ""),
              "error"
            );
          }
        } catch (error) {
          showAlert(
            "summaryAlert",
            "카드 생성 중 오류가 발생했습니다.",
            "error"
          );
        }
      }

      // 최종 카드 정보 렌더링
      function renderFinalCard() {
        const finalCardInfo = document.getElementById("finalCardInfo");

        let experienceText = "경험 내용";
        if (state.formData) {
          if (state.formData.type === "TODAY_DIARY") {
            experienceText = state.formData.description || "오늘의 일기";
          } else if (state.formData.type === "EXPERIENCE_REFLECTION") {
            experienceText = state.formData.description || "사례 돌아보기";
          }
        }

        finalCardInfo.innerHTML = `
                <h3>생성된 장점 카드</h3>
                <p><strong>카드 ID:</strong> ${state.createdCard.id}</p>
                <p><strong>경험:</strong> ${experienceText}</p>
                <p><strong>장점 카테고리:</strong> ${
                  state.selectedCoin.name
                }</p>
                <p><strong>발견한 장점:</strong> ${
                  state.selectedKeyword.name
                }</p>
                <p><strong>생성 시간:</strong> ${new Date().toLocaleString()}</p>
            `;
      }

      // 단계 표시
      function showStep(stepId) {
        document
          .querySelectorAll(".step")
          .forEach((step) => step.classList.remove("active"));
        document.getElementById(stepId).classList.add("active");

        const stepNumber = {
          selectionStep: 1,
          summaryStep: 2,
          completeStep: 3,
        };

        state.currentStep = stepNumber[stepId] || 1;
        updateProgress();
      }

      // 진행률 업데이트
      function updateProgress() {
        const progress = (state.currentStep / state.totalSteps) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
        document.getElementById("currentStepText").textContent =
          state.currentStep;
      }

      // 알림 표시
      function showAlert(elementId, message, type = "success") {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="alert ${type}">${message}</div>`;
      }

      // 로딩 표시
      function showLoading(elementId, message = "처리 중...") {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="alert">
                <span class="loading"></span>${message}
            </div>`;
      }

      // 알림 숨기기
      function hideAlert(elementId) {
        const element = document.getElementById(elementId);
        element.innerHTML = "";
      }

      // 페이지 초기화 실행
      initializePage();
    </script>
  </body>
</html>
