<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사례 돌아보기 2단계 - Voin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      }

      .progress-bar {
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 100%;
        transition: width 0.3s ease;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .step-indicator {
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .context-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .context-info .label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .context-info .title {
        font-size: 1.1rem;
        font-weight: bold;
      }

      .previous-answer {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .previous-answer .label {
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .previous-answer .content {
        color: #333;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .header h1 {
        color: #333;
        font-size: 1.8rem;
        margin-bottom: 15px;
        line-height: 1.4;
      }

      .header .description {
        color: #666;
        font-size: 1rem;
        line-height: 1.6;
      }

      .form-section {
        margin-bottom: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        color: #333;
        font-weight: 600;
        margin-bottom: 12px;
        font-size: 1.1rem;
      }

      .form-group textarea {
        width: 100%;
        min-height: 150px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.3s ease;
        background: #f9f9f9;
      }

      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .char-counter {
        text-align: right;
        color: #999;
        font-size: 0.9rem;
        margin-top: 8px;
      }

      .char-counter.warning {
        color: #f39c12;
      }

      .char-counter.error {
        color: #e74c3c;
      }

      .buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 40px;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-back {
        background: #e0e0e0;
        color: #333;
      }

      .btn-back:hover {
        background: #d0d0d0;
      }

      .btn-next {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-next.enabled {
        opacity: 1;
        cursor: pointer;
      }

      .btn-next.enabled:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        font-size: 1.1rem;
        margin-top: 20px;
      }

      .tips {
        background: #f0f4f8;
        border-left: 4px solid #667eea;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .tips h3 {
        color: #667eea;
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .tips ul {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.6;
        padding-left: 20px;
      }

      .tips li {
        margin-bottom: 5px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 30px 20px;
          margin: 10px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>

      <div class="header">
        <div class="step-indicator">STEP 2 / 2</div>
        <div class="context-info" id="contextInfo">
          <div class="label">선택된 상황 맥락</div>
          <div class="title" id="contextTitle">불러오는 중...</div>
        </div>

        <div class="previous-answer">
          <div class="label">📝 1단계에서 작성한 내용</div>
          <div class="content" id="previousAction">불러오는 중...</div>
        </div>

        <h1>💭 내 행동에 대해 어떻게 생각하시나요?</h1>
        <p class="description">
          방금 작성해주신 행동을 돌아보며,<br />
          그 행동에 대한 여러분의 생각이나 느낌을 자유롭게 적어보세요.
        </p>
      </div>

      <div class="tips">
        <h3>💡 작성 팁</h3>
        <ul>
          <li>그 행동을 하게 된 이유나 동기를 생각해보세요</li>
          <li>그 행동이 어떤 결과를 가져왔는지 생각해보세요</li>
          <li>비슷한 상황에서 또 그렇게 행동할 것 같은지 생각해보세요</li>
          <li>자신의 행동에서 발견할 수 있는 장점이나 특성을 생각해보세요</li>
        </ul>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label for="thoughtDescription">나의 생각 *</label>
          <textarea
            id="thoughtDescription"
            placeholder="예: 갈등 상황에서도 감정적으로 반응하지 않고 냉정하게 문제를 해결하려고 했던 것 같다. 모든 사람의 의견을 듣고 정리하는 과정에서 조율 능력이 발휘된 것 같고, 팀의 화합을 중요하게 생각하는 내 성격이 드러난 것 같다. 앞으로도 이런 상황에서는 비슷하게 행동할 것 같다."
            maxlength="500"
            oninput="updateCharCounter()"
            onkeyup="checkFormValid()"
          ></textarea>
          <div class="char-counter" id="charCounter">0 / 500자</div>
        </div>
      </div>

      <div class="buttons">
        <button class="btn btn-back" onclick="goBack()">🔙 이전으로</button>
        <button
          id="nextBtn"
          class="btn btn-next"
          disabled
          onclick="proceedToNext()"
        >
          장점 찾기로 🚀
        </button>
      </div>

      <div class="loading" id="loading">생각을 저장하는 중... ⏳</div>
    </div>

    <script>
      let formId = null;
      let contextId = null;
      let contextTitle = "";
      let actionDescription = "";

      // 페이지 로드 시 URL 파라미터에서 정보 가져오기
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        formId = urlParams.get("formId");
        contextId = urlParams.get("contextId");
        contextTitle = urlParams.get("contextTitle");
        actionDescription = urlParams.get("actionDescription");

        if (!formId || !contextId || !contextTitle || !actionDescription) {
          alert("잘못된 접근입니다. 처음부터 다시 시작해주세요.");
          window.location.href = "/situation-context-selection";
          return;
        }

        // 정보 표시
        document.getElementById("contextTitle").textContent = contextTitle;
        document.getElementById("previousAction").textContent =
          actionDescription;

        // 텍스트영역 포커스
        document.getElementById("thoughtDescription").focus();
      });

      function updateCharCounter() {
        const textarea = document.getElementById("thoughtDescription");
        const counter = document.getElementById("charCounter");
        const length = textarea.value.length;

        counter.textContent = `${length} / 500자`;

        if (length > 450) {
          counter.className = "char-counter error";
        } else if (length > 350) {
          counter.className = "char-counter warning";
        } else {
          counter.className = "char-counter";
        }
      }

      function checkFormValid() {
        const thoughtDescription = document
          .getElementById("thoughtDescription")
          .value.trim();
        const nextBtn = document.getElementById("nextBtn");

        if (thoughtDescription.length >= 10) {
          nextBtn.disabled = false;
          nextBtn.classList.add("enabled");
        } else {
          nextBtn.disabled = true;
          nextBtn.classList.remove("enabled");
        }
      }

      function goBack() {
        const params = new URLSearchParams({
          contextId: contextId,
          contextTitle: contextTitle,
        });
        window.location.href = `/experience-step1?${params.toString()}`;
      }

      async function proceedToNext() {
        const thoughtDescription = document
          .getElementById("thoughtDescription")
          .value.trim();

        if (!thoughtDescription || thoughtDescription.length < 10) {
          alert("생각을 10자 이상 입력해주세요.");
          return;
        }

        const loading = document.getElementById("loading");
        const nextBtn = document.getElementById("nextBtn");

        try {
          loading.style.display = "block";
          nextBtn.disabled = true;

          const response = await fetch(
            "/api/coin-finder/experience-review/step2",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                formId: parseInt(formId),
                thoughtDescription: thoughtDescription,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            // Form ID를 로컬 스토리지에 저장하고 장점 선택 페이지로 이동
            localStorage.setItem("currentFormId", formId);

            window.location.href = "/strength-selection";
          } else {
            throw new Error(result.message || "저장에 실패했습니다.");
          }
        } catch (error) {
          console.error("Error saving step 2:", error);
          alert("저장 중 오류가 발생했습니다: " + error.message);
          nextBtn.disabled = false;
          nextBtn.classList.add("enabled");
        } finally {
          loading.style.display = "none";
        }
      }

      // 키보드 단축키 지원 (Ctrl+Enter로 다음 단계)
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.key === "Enter") {
          if (!document.getElementById("nextBtn").disabled) {
            proceedToNext();
          }
        }
      });

      // 자동 저장 기능 (선택사항)
      let autoSaveTimeout;
      document
        .getElementById("thoughtDescription")
        .addEventListener("input", function () {
          clearTimeout(autoSaveTimeout);
          autoSaveTimeout = setTimeout(() => {
            const content = this.value.trim();
            if (content.length > 0) {
              localStorage.setItem("experienceStep2_thought", content);
            }
          }, 1000);
        });

      // 페이지 로드 시 자동 저장된 내용 복원
      window.addEventListener("load", function () {
        const savedContent = localStorage.getItem("experienceStep2_thought");
        if (savedContent) {
          document.getElementById("thoughtDescription").value = savedContent;
          updateCharCounter();
          checkFormValid();
        }
      });
    </script>
  </body>
</html>
