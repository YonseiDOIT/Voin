<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‚¬ë¡€ ëŒì•„ë³´ê¸° 2ë‹¨ê³„ - Voin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      }

      .progress-bar {
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 100%;
        transition: width 0.3s ease;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .step-indicator {
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .context-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .context-info .label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .context-info .title {
        font-size: 1.1rem;
        font-weight: bold;
      }

      .previous-answer {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .previous-answer .label {
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .previous-answer .content {
        color: #333;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .header h1 {
        color: #333;
        font-size: 1.8rem;
        margin-bottom: 15px;
        line-height: 1.4;
      }

      .header .description {
        color: #666;
        font-size: 1rem;
        line-height: 1.6;
      }

      .form-section {
        margin-bottom: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        color: #333;
        font-weight: 600;
        margin-bottom: 12px;
        font-size: 1.1rem;
      }

      .form-group textarea {
        width: 100%;
        min-height: 150px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.3s ease;
        background: #f9f9f9;
      }

      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .char-counter {
        text-align: right;
        color: #999;
        font-size: 0.9rem;
        margin-top: 8px;
      }

      .char-counter.warning {
        color: #f39c12;
      }

      .char-counter.error {
        color: #e74c3c;
      }

      .buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 40px;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-back {
        background: #e0e0e0;
        color: #333;
      }

      .btn-back:hover {
        background: #d0d0d0;
      }

      .btn-next {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-next.enabled {
        opacity: 1;
        cursor: pointer;
      }

      .btn-next.enabled:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        font-size: 1.1rem;
        margin-top: 20px;
      }

      .tips {
        background: #f0f4f8;
        border-left: 4px solid #667eea;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .tips h3 {
        color: #667eea;
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .tips ul {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.6;
        padding-left: 20px;
      }

      .tips li {
        margin-bottom: 5px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 30px 20px;
          margin: 10px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>

      <div class="header">
        <div class="step-indicator">STEP 2 / 2</div>
        <div class="context-info" id="contextInfo">
          <div class="label">ì„ íƒëœ ìƒí™© ë§¥ë½</div>
          <div class="title" id="contextTitle">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <div class="previous-answer">
          <div class="label">ğŸ“ 1ë‹¨ê³„ì—ì„œ ì‘ì„±í•œ ë‚´ìš©</div>
          <div class="content" id="previousAction">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>

        <h1>ğŸ’­ ë‚´ í–‰ë™ì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?</h1>
        <p class="description">
          ë°©ê¸ˆ ì‘ì„±í•´ì£¼ì‹  í–‰ë™ì„ ëŒì•„ë³´ë©°,<br />
          ê·¸ í–‰ë™ì— ëŒ€í•œ ì—¬ëŸ¬ë¶„ì˜ ìƒê°ì´ë‚˜ ëŠë‚Œì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”.
        </p>
      </div>

      <div class="tips">
        <h3>ğŸ’¡ ì‘ì„± íŒ</h3>
        <ul>
          <li>ê·¸ í–‰ë™ì„ í•˜ê²Œ ëœ ì´ìœ ë‚˜ ë™ê¸°ë¥¼ ìƒê°í•´ë³´ì„¸ìš”</li>
          <li>ê·¸ í–‰ë™ì´ ì–´ë–¤ ê²°ê³¼ë¥¼ ê°€ì ¸ì™”ëŠ”ì§€ ìƒê°í•´ë³´ì„¸ìš”</li>
          <li>ë¹„ìŠ·í•œ ìƒí™©ì—ì„œ ë˜ ê·¸ë ‡ê²Œ í–‰ë™í•  ê²ƒ ê°™ì€ì§€ ìƒê°í•´ë³´ì„¸ìš”</li>
          <li>ìì‹ ì˜ í–‰ë™ì—ì„œ ë°œê²¬í•  ìˆ˜ ìˆëŠ” ì¥ì ì´ë‚˜ íŠ¹ì„±ì„ ìƒê°í•´ë³´ì„¸ìš”</li>
        </ul>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label for="thoughtDescription">ë‚˜ì˜ ìƒê° *</label>
          <textarea
            id="thoughtDescription"
            placeholder="ì˜ˆ: ê°ˆë“± ìƒí™©ì—ì„œë„ ê°ì •ì ìœ¼ë¡œ ë°˜ì‘í•˜ì§€ ì•Šê³  ëƒ‰ì •í•˜ê²Œ ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ê³  í–ˆë˜ ê²ƒ ê°™ë‹¤. ëª¨ë“  ì‚¬ëŒì˜ ì˜ê²¬ì„ ë“£ê³  ì •ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ ì¡°ìœ¨ ëŠ¥ë ¥ì´ ë°œíœ˜ëœ ê²ƒ ê°™ê³ , íŒ€ì˜ í™”í•©ì„ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ëŠ” ë‚´ ì„±ê²©ì´ ë“œëŸ¬ë‚œ ê²ƒ ê°™ë‹¤. ì•ìœ¼ë¡œë„ ì´ëŸ° ìƒí™©ì—ì„œëŠ” ë¹„ìŠ·í•˜ê²Œ í–‰ë™í•  ê²ƒ ê°™ë‹¤."
            maxlength="500"
            oninput="updateCharCounter()"
            onkeyup="checkFormValid()"
          ></textarea>
          <div class="char-counter" id="charCounter">0 / 500ì</div>
        </div>
      </div>

      <div class="buttons">
        <button class="btn btn-back" onclick="goBack()">ğŸ”™ ì´ì „ìœ¼ë¡œ</button>
        <button
          id="nextBtn"
          class="btn btn-next"
          disabled
          onclick="proceedToNext()"
        >
          ì¥ì  ì°¾ê¸°ë¡œ ğŸš€
        </button>
      </div>

      <div class="loading" id="loading">ìƒê°ì„ ì €ì¥í•˜ëŠ” ì¤‘... â³</div>
    </div>

    <script>
      let formId = null;
      let contextId = null;
      let contextTitle = "";
      let actionDescription = "";

      // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„°ì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        formId = urlParams.get("formId");
        contextId = urlParams.get("contextId");
        contextTitle = urlParams.get("contextTitle");
        actionDescription = urlParams.get("actionDescription");

        if (!formId || !contextId || !contextTitle || !actionDescription) {
          alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.");
          window.location.href = "/situation-context-selection";
          return;
        }

        // ì •ë³´ í‘œì‹œ
        document.getElementById("contextTitle").textContent = contextTitle;
        document.getElementById("previousAction").textContent =
          actionDescription;

        // í…ìŠ¤íŠ¸ì˜ì—­ í¬ì»¤ìŠ¤
        document.getElementById("thoughtDescription").focus();
      });

      function updateCharCounter() {
        const textarea = document.getElementById("thoughtDescription");
        const counter = document.getElementById("charCounter");
        const length = textarea.value.length;

        counter.textContent = `${length} / 500ì`;

        if (length > 450) {
          counter.className = "char-counter error";
        } else if (length > 350) {
          counter.className = "char-counter warning";
        } else {
          counter.className = "char-counter";
        }
      }

      function checkFormValid() {
        const thoughtDescription = document
          .getElementById("thoughtDescription")
          .value.trim();
        const nextBtn = document.getElementById("nextBtn");

        if (thoughtDescription.length >= 10) {
          nextBtn.disabled = false;
          nextBtn.classList.add("enabled");
        } else {
          nextBtn.disabled = true;
          nextBtn.classList.remove("enabled");
        }
      }

      function goBack() {
        const params = new URLSearchParams({
          contextId: contextId,
          contextTitle: contextTitle,
        });
        window.location.href = `/experience-step1?${params.toString()}`;
      }

      async function proceedToNext() {
        const thoughtDescription = document
          .getElementById("thoughtDescription")
          .value.trim();

        if (!thoughtDescription || thoughtDescription.length < 10) {
          alert("ìƒê°ì„ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const loading = document.getElementById("loading");
        const nextBtn = document.getElementById("nextBtn");

        try {
          loading.style.display = "block";
          nextBtn.disabled = true;

          const response = await fetch(
            "/api/coin-finder/experience-review/step2",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                formId: parseInt(formId),
                thoughtDescription: thoughtDescription,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            // Form IDë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ê³  ì¥ì  ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™
            localStorage.setItem("currentFormId", formId);

            window.location.href = "/strength-selection";
          } else {
            throw new Error(result.message || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("Error saving step 2:", error);
          alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          nextBtn.disabled = false;
          nextBtn.classList.add("enabled");
        } finally {
          loading.style.display = "none";
        }
      }

      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì› (Ctrl+Enterë¡œ ë‹¤ìŒ ë‹¨ê³„)
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.key === "Enter") {
          if (!document.getElementById("nextBtn").disabled) {
            proceedToNext();
          }
        }
      });

      // ìë™ ì €ì¥ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)
      let autoSaveTimeout;
      document
        .getElementById("thoughtDescription")
        .addEventListener("input", function () {
          clearTimeout(autoSaveTimeout);
          autoSaveTimeout = setTimeout(() => {
            const content = this.value.trim();
            if (content.length > 0) {
              localStorage.setItem("experienceStep2_thought", content);
            }
          }, 1000);
        });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì €ì¥ëœ ë‚´ìš© ë³µì›
      window.addEventListener("load", function () {
        const savedContent = localStorage.getItem("experienceStep2_thought");
        if (savedContent) {
          document.getElementById("thoughtDescription").value = savedContent;
          updateCharCounter();
          checkFormValid();
        }
      });
    </script>
  </body>
</html>
