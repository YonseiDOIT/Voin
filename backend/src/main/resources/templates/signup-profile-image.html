<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì • - VOIN</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .signup-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }

      .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: bold;
        color: white;
      }

      .step.completed {
        background: #28a745;
      }

      .step.active {
        background: #667eea;
      }

      .step-line {
        width: 40px;
        height: 2px;
        background: #667eea;
        margin-top: 19px;
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        line-height: 1.5;
      }

      .profile-preview {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        border: 1px solid #e1e1e1;
      }

      .profile-preview h3 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .preview-image {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto 15px;
        background: #e1e1e1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: #999;
        overflow: hidden;
      }

      .preview-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .profile-options {
        margin-bottom: 20px;
      }

      .option {
        display: block;
        padding: 15px;
        border: 2px solid #e1e1e1;
        border-radius: 10px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .option:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .option.selected {
        border-color: #667eea;
        background-color: #667eea;
        color: white;
      }

      .option-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .option input[type="radio"] {
        margin-right: 10px;
      }

      .option-content {
        flex: 1;
      }

      .option-image {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-left: 10px;
        background: #e1e1e1;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .option-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .custom-options {
        display: none;
        margin-top: 15px;
      }

      .custom-options.show {
        display: block;
      }

      .upload-tabs {
        display: flex;
        margin-bottom: 15px;
        background: #f8f9ff;
        border-radius: 8px;
        padding: 4px;
      }

      .tab-btn {
        flex: 1;
        padding: 10px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .tab-btn.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .url-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e1e1e1;
        border-radius: 8px;
        font-size: 14px;
      }

      .url-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .file-upload-area {
        border: 2px dashed #e1e1e1;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .file-upload-area:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .file-upload-area.dragover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .file-input {
        display: none;
      }

      .upload-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 15px;
        color: #999;
      }

      .upload-text {
        color: #666;
      }

      .upload-main {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .upload-sub {
        font-size: 12px;
        color: #999;
      }

      .file-preview {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9ff;
        border-radius: 8px;
        display: none;
      }

      .file-preview.show {
        display: block;
      }

      .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .file-details {
        display: flex;
        align-items: center;
      }

      .file-thumb {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        margin-right: 10px;
        overflow: hidden;
        background: #e1e1e1;
      }

      .file-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-file {
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
      }

      .complete-button {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.3s ease;
        width: 100%;
        margin-top: 20px;
      }

      .complete-button:hover {
        transform: translateY(-2px);
      }

      .complete-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        color: #e74c3c;
        margin-top: 10px;
        display: none;
      }

      .loading {
        display: none;
        margin-top: 10px;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="signup-container">
      <!-- ë‹¨ê³„ í‘œì‹œ -->
      <div class="step-indicator">
        <div class="step completed">1</div>
        <div class="step-line"></div>
        <div class="step active">2</div>
      </div>

      <h1>ğŸ–¼ï¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •</h1>
      <p class="subtitle">
        ë§ˆì§€ë§‰ ë‹¨ê³„ì˜ˆìš”! í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ë©´<br />
        VOIN íšŒì›ê°€ì…ì´ ì™„ë£Œë©ë‹ˆë‹¤.
      </p>

      <div class="profile-preview">
        <h3>ë¯¸ë¦¬ë³´ê¸°</h3>
        <div class="preview-image" id="previewImage">ğŸ‘¤</div>
        <div id="preview-nickname">ë‹‰ë„¤ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <form class="profile-form" id="profileForm">
        <div class="profile-options">
          <div
            class="option"
            onclick="selectOption('kakao')"
            id="kakao-option-container"
          >
            <div class="option-header">
              <input
                type="radio"
                name="imageType"
                value="kakao"
                id="kakao-option"
              />
              <div class="option-content">
                <strong>ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ì´ë¯¸ì§€ ì‚¬ìš©</strong><br />
                í˜„ì¬ ì¹´ì¹´ì˜¤ì— ì„¤ì •ëœ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•´ìš”
              </div>
              <div class="option-image" id="kakao-image">ğŸ‘¤</div>
            </div>
          </div>

          <div
            class="option"
            onclick="selectOption('custom')"
            id="custom-option-container"
          >
            <div class="option-header">
              <input
                type="radio"
                name="imageType"
                value="custom"
                id="custom-option"
              />
              <div class="option-content">
                <strong>ë‹¤ë¥¸ ì´ë¯¸ì§€ ì‚¬ìš©</strong><br />
                ì›í•˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ì„ íƒí•´ë³´ì„¸ìš”
              </div>
              <div class="option-image">ğŸ¨</div>
            </div>

            <div class="custom-options" id="customOptions">
              <div class="upload-tabs">
                <button
                  type="button"
                  class="tab-btn active"
                  onclick="switchTab('url')"
                >
                  URL ì…ë ¥
                </button>
                <button
                  type="button"
                  class="tab-btn"
                  onclick="switchTab('file')"
                >
                  íŒŒì¼ ì„ íƒ
                </button>
              </div>

              <div class="tab-content active" id="urlTab">
                <input
                  type="url"
                  class="url-input"
                  id="customImageUrl"
                  placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://example.com/image.jpg)"
                />
              </div>

              <div class="tab-content" id="fileTab">
                <div
                  class="file-upload-area"
                  onclick="document.getElementById('fileInput').click()"
                >
                  <svg
                    class="upload-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                    <circle cx="8.5" cy="8.5" r="1.5" />
                    <polyline points="21,15 16,10 5,21" />
                  </svg>
                  <div class="upload-text">
                    <span class="upload-main">ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</span>
                    <span class="upload-sub">JPG, PNG, GIF (ìµœëŒ€ 5MB)</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="fileInput"
                  class="file-input"
                  accept="image/*"
                />

                <div class="file-preview" id="filePreview">
                  <div class="file-info">
                    <div class="file-details">
                      <div class="file-thumb" id="fileThumb"></div>
                      <div>
                        <div id="fileName"></div>
                        <div id="fileSize"></div>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="remove-file"
                      onclick="removeFile()"
                    >
                      ì œê±°
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="loading" id="loadingMessage">íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...</div>

        <button type="submit" class="complete-button" id="completeButton">
          ğŸ‰ íšŒì›ê°€ì… ì™„ë£Œí•˜ê¸°
        </button>
      </form>
    </div>

    <script th:inline="javascript">
      const accessToken = /*[[${accessToken}]]*/ "";
      let kakaoUserInfo = null;
      let selectedNickname = "";
      let selectedFile = null;
      let currentImageType = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì •ëœ ë‹‰ë„¤ì„ ì •ë³´ ë¡œë“œ
      async function loadSignupData() {
        if (!accessToken) {
          showError("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch("/signup/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `access_token=${accessToken}`,
          });

          const result = await response.json();

          if (result.success && result.data) {
            kakaoUserInfo = result.data.kakaoUserInfo;
            selectedNickname = result.data.currentNickname;

            // ë‹‰ë„¤ì„ í‘œì‹œ
            document.getElementById("preview-nickname").textContent =
              selectedNickname;

            // ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ
            if (kakaoUserInfo.profileImage) {
              const kakaoImg = document.createElement("img");
              kakaoImg.src = kakaoUserInfo.profileImage;
              kakaoImg.onerror = function () {
                this.parentElement.innerHTML = "ğŸ‘¤";
              };
              document.getElementById("kakao-image").innerHTML = "";
              document.getElementById("kakao-image").appendChild(kakaoImg);
            }

            // ê¸°ë³¸ìœ¼ë¡œ ì¹´ì¹´ì˜¤ ì´ë¯¸ì§€ ì„ íƒ
            selectOption("kakao");
          } else {
            showError(result.message || "íšŒì›ê°€ì… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          showError("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          console.error("Error:", error);
        }
      }

      function selectOption(type) {
        currentImageType = type;

        // ëª¨ë“  ì˜µì…˜ ì„ íƒ í•´ì œ
        document
          .querySelectorAll(".option")
          .forEach((opt) => opt.classList.remove("selected"));
        document
          .querySelectorAll('input[name="imageType"]')
          .forEach((input) => (input.checked = false));

        // ì„ íƒëœ ì˜µì…˜ í™œì„±í™”
        const selectedOption = document.getElementById(
          `${type}-option-container`
        );
        selectedOption.classList.add("selected");
        document.getElementById(`${type}-option`).checked = true;

        // ì»¤ìŠ¤í…€ ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€
        const customOptions = document.getElementById("customOptions");
        if (type === "custom") {
          customOptions.classList.add("show");
        } else {
          customOptions.classList.remove("show");
          // ì»¤ìŠ¤í…€ ì…ë ¥ ì´ˆê¸°í™”
          document.getElementById("customImageUrl").value = "";
          removeFile();
        }

        updatePreview();
      }

      function switchTab(tabType) {
        // íƒ­ ë²„íŠ¼ í™œì„±í™”
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        // íƒ­ ì»¨í…ì¸  í‘œì‹œ
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        document.getElementById(`${tabType}Tab`).classList.add("active");

        // ë‹¤ë¥¸ íƒ­ì˜ ì…ë ¥ ì´ˆê¸°í™”
        if (tabType === "url") {
          removeFile();
        } else {
          document.getElementById("customImageUrl").value = "";
        }

        updatePreview();
      }

      function updatePreview() {
        const preview = document.getElementById("previewImage");

        if (currentImageType === "kakao" && kakaoUserInfo?.profileImage) {
          const img = document.createElement("img");
          img.src = kakaoUserInfo.profileImage;
          img.onerror = function () {
            preview.innerHTML = "ğŸ‘¤";
          };
          preview.innerHTML = "";
          preview.appendChild(img);
        } else if (currentImageType === "custom") {
          const activeTab = document.querySelector(".tab-content.active");

          if (activeTab.id === "urlTab") {
            const customUrl = document.getElementById("customImageUrl").value;
            if (customUrl) {
              const img = document.createElement("img");
              img.src = customUrl;
              img.onerror = function () {
                preview.innerHTML = "âŒ";
              };
              preview.innerHTML = "";
              preview.appendChild(img);
            } else {
              preview.innerHTML = "ğŸ¨";
            }
          } else if (activeTab.id === "fileTab") {
            if (selectedFile) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const img = document.createElement("img");
                img.src = e.target.result;
                preview.innerHTML = "";
                preview.appendChild(img);
              };
              reader.readAsDataURL(selectedFile);
            } else {
              preview.innerHTML = "ğŸ¨";
            }
          }
        } else {
          preview.innerHTML = "ğŸ‘¤";
        }
      }

      // íŒŒì¼ ì…ë ¥ ì²˜ë¦¬
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            // íŒŒì¼ í¬ê¸° ê²€ì¦ (5MB)
            if (file.size > 5 * 1024 * 1024) {
              showError("íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
              return;
            }

            // íŒŒì¼ íƒ€ì… ê²€ì¦
            if (!file.type.startsWith("image/")) {
              showError("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
              return;
            }

            selectedFile = file;
            showFilePreview(file);
            updatePreview();
          }
        });

      function showFilePreview(file) {
        const preview = document.getElementById("filePreview");
        const fileName = document.getElementById("fileName");
        const fileSize = document.getElementById("fileSize");
        const fileThumb = document.getElementById("fileThumb");

        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);

        // íŒŒì¼ ì¸ë„¤ì¼
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          fileThumb.innerHTML = "";
          fileThumb.appendChild(img);
        };
        reader.readAsDataURL(file);

        preview.classList.add("show");
      }

      function removeFile() {
        selectedFile = null;
        document.getElementById("fileInput").value = "";
        document.getElementById("filePreview").classList.remove("show");
        updatePreview();
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
      const fileUploadArea = document.querySelector(".file-upload-area");

      fileUploadArea.addEventListener("dragover", function (e) {
        e.preventDefault();
        this.classList.add("dragover");
      });

      fileUploadArea.addEventListener("dragleave", function (e) {
        e.preventDefault();
        this.classList.remove("dragover");
      });

      fileUploadArea.addEventListener("drop", function (e) {
        e.preventDefault();
        this.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          const file = files[0];
          document.getElementById("fileInput").files = files;
          document
            .getElementById("fileInput")
            .dispatchEvent(new Event("change"));
        }
      });

      // URL ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      document
        .getElementById("customImageUrl")
        .addEventListener("input", updatePreview);

      // í¼ ì œì¶œ ì²˜ë¦¬
      document
        .getElementById("profileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const selectedType = document.querySelector(
            'input[name="imageType"]:checked'
          )?.value;

          if (!selectedType) {
            showError("í”„ë¡œí•„ ì´ë¯¸ì§€ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          let profileImageData = "";

          if (selectedType === "custom") {
            const activeTab = document.querySelector(".tab-content.active");

            if (activeTab.id === "urlTab") {
              const customUrl = document
                .getElementById("customImageUrl")
                .value.trim();
              if (!customUrl) {
                showError("ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
              }
              profileImageData = customUrl;
            } else if (activeTab.id === "fileTab") {
              if (!selectedFile) {
                showError("ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
              }
              // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
              profileImageData = await fileToBase64(selectedFile);
            }
          }

          const requestData = {
            accessToken: accessToken,
            profileImageUrl: profileImageData,
            useKakaoProfileImage: selectedType === "kakao",
          };

          try {
            document.getElementById("completeButton").disabled = true;
            document.getElementById("loadingMessage").style.display = "block";

            const response = await fetch("/signup/profile-image", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            });

            const result = await response.json();

            if (result.success) {
              // íšŒì›ê°€ì… ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
              const token = result.data.jwtToken;
              window.location.href = `/signup/complete?token=${token}`;
            } else {
              showError(result.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              document.getElementById("completeButton").disabled = false;
              document.getElementById("loadingMessage").style.display = "none";
            }
          } catch (error) {
            showError("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            document.getElementById("completeButton").disabled = false;
            document.getElementById("loadingMessage").style.display = "none";
            console.error("Error:", error);
          }
        });

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";

        setTimeout(() => {
          errorElement.style.display = "none";
        }, 5000);
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      loadSignupData();
    </script>
  </body>
</html>
