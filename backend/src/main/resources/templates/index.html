<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VOIN - ì¥ì ì„ ë°œê²¬í•˜ëŠ” ì—¬ì •</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 15px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
        line-height: 1.6;
      }

      .content {
        padding: 40px 30px;
      }

      .section {
        margin-bottom: 40px;
      }

      .section h2 {
        font-size: 1.5em;
        margin-bottom: 20px;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .login-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin-bottom: 40px;
      }

      .user-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
      }

      .welcome-text {
        font-size: 1.1em;
        color: #495057;
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .feature-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .feature-card:hover {
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
      }

      .feature-card.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #f8f9fa;
      }

      .feature-card.disabled:hover {
        transform: none;
        box-shadow: none;
        border-color: #e9ecef;
      }

      .feature-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
      }

      .feature-title {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
      }

      .feature-description {
        color: #6c757d;
        line-height: 1.5;
        margin-bottom: 20px;
        font-size: 0.95em;
      }

      .btn {
        display: inline-block;
        padding: 12px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        font-size: 0.95em;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.secondary:hover {
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
      }

      .btn.kakao {
        background: #fee500;
        color: #3c1e1e;
      }

      .btn.kakao:hover {
        box-shadow: 0 6px 20px rgba(254, 229, 0, 0.4);
      }

      .btn.large {
        padding: 15px 30px;
        font-size: 1em;
      }

      .admin-section {
        border-top: 1px solid #e9ecef;
        padding-top: 30px;
        text-align: center;
      }

      .admin-links {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .admin-links .btn {
        padding: 8px 16px;
        font-size: 0.85em;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: center;
        font-weight: 500;
        font-size: 0.9em;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .features-grid {
          grid-template-columns: 1fr;
        }

        .admin-links {
          flex-direction: column;
          align-items: center;
        }

        .header {
          padding: 30px 20px;
        }

        .header h1 {
          font-size: 2em;
        }

        .content {
          padding: 30px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸª™ VOIN</h1>
        <p>ë‹¹ì‹ ì˜ ìˆ¨ê²¨ì§„ ì¥ì ì„ ë°œê²¬í•˜ê³  ì†Œì¤‘í•œ ì‚¬ëŒë“¤ê³¼ ë‚˜ëˆ„ëŠ” íŠ¹ë³„í•œ ê³µê°„</p>
      </div>

      <div class="content">
        <!-- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div class="section">
          <div class="login-section">
            <!-- ë¡œê·¸ì¸ ì „ ìƒíƒœ -->
            <div id="loginRequired">
              <h2>ğŸ”‘ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</h2>
              <p style="margin-bottom: 20px">
                VOINì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
              </p>
              <button class="btn kakao large" onclick="startKakaoLogin()">
                ğŸ¯ ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸í•˜ê¸°
              </button>
            </div>

            <!-- ë¡œê·¸ì¸ í›„ ìƒíƒœ -->
            <div id="loggedInStatus" style="display: none">
              <div class="user-info">
                <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                <div class="welcome-text">
                  ì•ˆë…•í•˜ì„¸ìš”, <span id="userNickname">ì‚¬ìš©ì</span>ë‹˜!
                </div>
              </div>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  justify-content: center;
                  flex-wrap: wrap;
                "
              >
                <a href="/cards" class="btn">ë‚´ ì½”ì¸ ë³´ê¸°</a>
                <button class="btn secondary" onclick="logout()">
                  ë¡œê·¸ì•„ì›ƒ
                </button>
              </div>
            </div>

            <div id="loginStatus" class="status" style="display: none"></div>
          </div>
        </div>

        <!-- ì½”ì¸ ìƒì„± ë°©ë²• ì„ íƒ -->
        <div class="section">
          <h2>ğŸª™ ì½”ì¸ ìƒì„±í•˜ê¸°</h2>
          <div class="features-grid">
            <div class="feature-card" onclick="navigateToFeature('/diary')">
              <div class="feature-icon">ğŸ“</div>
              <div class="feature-title">ì˜¤ëŠ˜ì˜ ì¼ê¸°</div>
              <div class="feature-description">
                ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©° ì¼ìƒì—ì„œ ë¹›ë‚˜ëŠ” ë‚˜ì˜ ì¥ì ì„ ë°œê²¬í•´ë³´ì„¸ìš”
              </div>
              <button class="btn">ì¼ê¸° ì“°ëŸ¬ ê°€ê¸°</button>
            </div>

            <div
              class="feature-card"
              onclick="navigateToFeature('/experience/select-context')"
            >
              <div class="feature-icon">ğŸ’­</div>
              <div class="feature-title">ì‚¬ë¡€ ëŒì•„ë³´ê¸°</div>
              <div class="feature-description">
                íŠ¹ë³„í–ˆë˜ ê²½í—˜ì„ ë˜ëŒì•„ë³´ë©° ê·¸ ìˆœê°„ì— ë“œëŸ¬ë‚œ ë‚˜ì˜ ì¥ì ì„
                ì°¾ì•„ë³´ì„¸ìš”
              </div>
              <button class="btn">ëŒì•„ë³´ëŸ¬ ê°€ê¸°</button>
            </div>

            <div class="feature-card disabled">
              <div class="feature-icon">ğŸ‘¥</div>
              <div class="feature-title">í•¨ê»˜í•œ ì¶”ì–µ ë– ì˜¬ë¦¬ê¸°</div>
              <div class="feature-description">
                ì†Œì¤‘í•œ ì‚¬ëŒë“¤ê³¼ì˜ ì¶”ì–µì„ í†µí•´ ì„œë¡œì˜ ì¥ì ì„ ë°œê²¬í•˜ê³ 
                ê³µìœ í•´ë³´ì„¸ìš”
              </div>
              <button class="btn secondary">ì¤€ë¹„ ì¤‘</button>
            </div>
          </div>
        </div>

        <!-- ê´€ë¦¬ì/ê°œë°œì ë„êµ¬ -->
        <div class="admin-section">
          <h2>ğŸ› ï¸ ê°œë°œì ë„êµ¬</h2>
          <div class="admin-links">
            <a href="/swagger-ui.html" class="btn secondary" target="_blank"
              >ğŸ“‹ API ë¬¸ì„œ</a
            >
            <a href="/h2-console" class="btn secondary" target="_blank"
              >ğŸ—„ï¸ DB</a
            >
            <a href="/flow-test.html" class="btn secondary">ğŸ§ª í”Œë¡œìš° í…ŒìŠ¤íŠ¸</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ì „ì—­ ìƒíƒœ
      const state = {
        isLoggedIn: false,
        user: null,
      };

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      function initializePage() {
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë¡œê·¸ì¸ ê²°ê³¼ í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const loginSuccess = urlParams.get("login_success");

        if (loginSuccess === "true") {
          handleLoginResult(urlParams);
        } else {
          // ê¸°ì¡´ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
          checkLoginStatus();
        }
      }

      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      function checkLoginStatus() {
        // ì„ì‹œë¡œ localStorageì—ì„œ í™•ì¸ (ì‹¤ì œë¡œëŠ” ì„œë²„ API í˜¸ì¶œ)
        const loginData = localStorage.getItem("voin_login");
        if (loginData) {
          try {
            const user = JSON.parse(loginData);
            updateLoginUI(true, user);
          } catch (e) {
            localStorage.removeItem("voin_login");
            updateLoginUI(false);
          }
        } else {
          updateLoginUI(false);
        }
      }

      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘
      async function startKakaoLogin() {
        showStatus("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...", false);

        try {
          const response = await fetch("/auth/kakao/url");
          const data = await response.json();

          if (data.success && data.data) {
            window.location.href = data.data;
          } else {
            showStatus("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ URLì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", true);
          }
        } catch (error) {
          showStatus("ë¡œê·¸ì¸ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
        }
      }

      // ë¡œê·¸ì¸ ê²°ê³¼ ì²˜ë¦¬
      function handleLoginResult(urlParams) {
        const accessToken = urlParams.get("access_token");
        const memberId = urlParams.get("member_id");
        const token = urlParams.get("token");
        const nickname = urlParams.get("nickname");
        const isNewMember = urlParams.get("is_new_member");
        const isExisting = urlParams.get("is_existing");

        console.log("Login result:", {
          accessToken,
          memberId,
          token,
          nickname,
          isNewMember,
          isExisting,
        });

        if (isExisting === "true" && memberId && token) {
          // ê¸°ì¡´ íšŒì› ë¡œê·¸ì¸ ì„±ê³µ
          const user = {
            id: memberId,
            member_id: memberId, // í˜¸í™˜ì„±ì„ ìœ„í•´ ë‘ í‚¤ ëª¨ë‘ ì œê³µ
            token: token,
            nickname: nickname || "ì‚¬ìš©ì",
            loginTime: Date.now(),
          };

          localStorage.setItem("voin_login", JSON.stringify(user));
          updateLoginUI(true, user);
          showStatus("ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", false);
        } else if (isNewMember === "true" && accessToken) {
          // ì‹ ê·œ íšŒì› - íšŒì›ê°€ì… í•„ìš”
          showStatus(
            "íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹‰ë„¤ì„ ì„¤ì • í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.",
            false
          );
          setTimeout(() => {
            window.location.href = `/signup/nickname?access_token=${accessToken}`;
          }, 2000);
        } else {
          showStatus("ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
        }

        // URL ì •ë¦¬
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // ë¡œê·¸ì¸ UI ì—…ë°ì´íŠ¸
      function updateLoginUI(isLoggedIn, user = null) {
        state.isLoggedIn = isLoggedIn;
        state.user = user;

        const loginRequired = document.getElementById("loginRequired");
        const loggedInStatus = document.getElementById("loggedInStatus");
        const userNickname = document.getElementById("userNickname");
        const userAvatar = document.getElementById("userAvatar");

        if (isLoggedIn && user) {
          loginRequired.style.display = "none";
          loggedInStatus.style.display = "block";
          userNickname.textContent = user.nickname || "ì‚¬ìš©ì";
          userAvatar.textContent = (user.nickname || "ì‚¬ìš©ì")[0];
        } else {
          loginRequired.style.display = "block";
          loggedInStatus.style.display = "none";
        }
      }

      // ë¡œê·¸ì•„ì›ƒ
      function logout() {
        localStorage.removeItem("voin_login");
        updateLoginUI(false);
        showStatus("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.", false);
      }

      // ê¸°ëŠ¥ í˜ì´ì§€ë¡œ ì´ë™
      function navigateToFeature(url) {
        if (!state.isLoggedIn) {
          showStatus("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.", true);
          return;
        }
        window.location.href = url;
      }

      // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      function showStatus(message, isError = false) {
        const statusEl = document.getElementById("loginStatus");
        statusEl.style.display = "block";
        statusEl.textContent = message;
        statusEl.className = `status ${isError ? "error" : "success"}`;

        // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        setTimeout(() => {
          statusEl.style.display = "none";
        }, 3000);
      }

      // í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤í–‰
      initializePage();
    </script>
  </body>
</html>
