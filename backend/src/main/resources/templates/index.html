<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VOIN - 장점을 발견하는 여정</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 15px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
        line-height: 1.6;
      }

      .content {
        padding: 40px 30px;
      }

      .section {
        margin-bottom: 40px;
      }

      .section h2 {
        font-size: 1.5em;
        margin-bottom: 20px;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .login-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        margin-bottom: 40px;
      }

      .user-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
      }

      .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
      }

      .welcome-text {
        font-size: 1.1em;
        color: #495057;
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .feature-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .feature-card:hover {
        border-color: #667eea;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
      }

      .feature-card.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #f8f9fa;
      }

      .feature-card.disabled:hover {
        transform: none;
        box-shadow: none;
        border-color: #e9ecef;
      }

      .feature-icon {
        font-size: 2.5em;
        margin-bottom: 15px;
      }

      .feature-title {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 10px;
        color: #495057;
      }

      .feature-description {
        color: #6c757d;
        line-height: 1.5;
        margin-bottom: 20px;
        font-size: 0.95em;
      }

      .btn {
        display: inline-block;
        padding: 12px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        font-size: 0.95em;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.secondary:hover {
        box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
      }

      .btn.kakao {
        background: #fee500;
        color: #3c1e1e;
      }

      .btn.kakao:hover {
        box-shadow: 0 6px 20px rgba(254, 229, 0, 0.4);
      }

      .btn.large {
        padding: 15px 30px;
        font-size: 1em;
      }

      .admin-section {
        border-top: 1px solid #e9ecef;
        padding-top: 30px;
        text-align: center;
      }

      .admin-links {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .admin-links .btn {
        padding: 8px 16px;
        font-size: 0.85em;
      }

      .status {
        padding: 12px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: center;
        font-weight: 500;
        font-size: 0.9em;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      @media (max-width: 768px) {
        .features-grid {
          grid-template-columns: 1fr;
        }

        .admin-links {
          flex-direction: column;
          align-items: center;
        }

        .header {
          padding: 30px 20px;
        }

        .header h1 {
          font-size: 2em;
        }

        .content {
          padding: 30px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🪙 VOIN</h1>
        <p>당신의 숨겨진 장점을 발견하고 소중한 사람들과 나누는 특별한 공간</p>
      </div>

      <div class="content">
        <!-- 카카오 로그인 섹션 -->
        <div class="section">
          <div class="login-section">
            <!-- 로그인 전 상태 -->
            <div id="loginRequired">
              <h2>🔑 카카오 로그인</h2>
              <p style="margin-bottom: 20px">
                VOIN의 모든 기능을 사용하려면 로그인이 필요합니다.
              </p>
              <button class="btn kakao large" onclick="startKakaoLogin()">
                🍯 카카오로 로그인하기
              </button>
            </div>

            <!-- 로그인 후 상태 -->
            <div id="loggedInStatus" style="display: none">
              <div class="user-info">
                <div class="user-avatar" id="userAvatar">👤</div>
                <div class="welcome-text">
                  안녕하세요, <span id="userNickname">사용자</span>님!
                </div>
              </div>
              <div
                style="
                  display: flex;
                  gap: 10px;
                  justify-content: center;
                  flex-wrap: wrap;
                "
              >
                <a href="/cards" class="btn">내 코인 보기</a>
                <button class="btn secondary" onclick="logout()">
                  로그아웃
                </button>
              </div>
            </div>

            <div id="loginStatus" class="status" style="display: none"></div>
          </div>
        </div>

        <!-- 코인 생성 방법 선택 -->
        <div class="section">
          <h2>🪙 코인 생성하기</h2>
          <div class="features-grid">
            <div class="feature-card" onclick="navigateToFeature('/diary')">
              <div class="feature-icon">📝</div>
              <div class="feature-title">오늘의 일기</div>
              <div class="feature-description">
                오늘 하루를 돌아보며 일상에서 빛나는 나의 장점을 발견해보세요
              </div>
              <button class="btn">일기 쓰러 가기</button>
            </div>

            <div
              class="feature-card"
              onclick="navigateToFeature('/experience/select-context')"
            >
              <div class="feature-icon">💭</div>
              <div class="feature-title">사례 돌아보기</div>
              <div class="feature-description">
                특별했던 경험을 되돌아보며 그 순간에 드러난 나의 장점을
                찾아보세요
              </div>
              <button class="btn">돌아보러 가기</button>
            </div>

            <div class="feature-card disabled">
              <div class="feature-icon">👥</div>
              <div class="feature-title">함께한 추억 떠올리기</div>
              <div class="feature-description">
                소중한 사람들과의 추억을 통해 서로의 장점을 발견하고
                공유해보세요
              </div>
              <button class="btn secondary">준비 중</button>
            </div>
          </div>
        </div>

        <!-- 관리자/개발자 도구 -->
        <div class="admin-section">
          <h2>🛠️ 개발자 도구</h2>
          <div class="admin-links">
            <a href="/swagger-ui.html" class="btn secondary" target="_blank"
              >📋 API 문서</a
            >
            <a href="/h2-console" class="btn secondary" target="_blank"
              >🗄️ DB</a
            >
            <a href="/flow-test.html" class="btn secondary">🧪 플로우 테스트</a>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 전역 상태
      const state = {
        isLoggedIn: false,
        user: null,
      };

      // 페이지 로드 시 초기화
      function initializePage() {
        // URL 파라미터에서 로그인 결과 확인
        const urlParams = new URLSearchParams(window.location.search);
        const loginSuccess = urlParams.get("login_success");

        if (loginSuccess === "true") {
          handleLoginResult(urlParams);
        } else {
          // 기존 로그인 상태 확인
          checkLoginStatus();
        }
      }

      // 로그인 상태 확인
      function checkLoginStatus() {
        // 임시로 localStorage에서 확인 (실제로는 서버 API 호출)
        const loginData = localStorage.getItem("voin_login");
        if (loginData) {
          try {
            const user = JSON.parse(loginData);
            updateLoginUI(true, user);
          } catch (e) {
            localStorage.removeItem("voin_login");
            updateLoginUI(false);
          }
        } else {
          updateLoginUI(false);
        }
      }

      // 카카오 로그인 시작
      async function startKakaoLogin() {
        showStatus("카카오 로그인 페이지로 이동 중...", false);

        try {
          const response = await fetch("/auth/kakao/url");
          const data = await response.json();

          if (data.success && data.data) {
            window.location.href = data.data;
          } else {
            showStatus("카카오 로그인 URL을 가져올 수 없습니다.", true);
          }
        } catch (error) {
          showStatus("로그인 준비 중 오류가 발생했습니다.", true);
        }
      }

      // 로그인 결과 처리
      function handleLoginResult(urlParams) {
        const accessToken = urlParams.get("access_token");
        const memberId = urlParams.get("member_id");
        const token = urlParams.get("token");
        const nickname = urlParams.get("nickname");
        const isNewMember = urlParams.get("is_new_member");
        const isExisting = urlParams.get("is_existing");

        console.log("Login result:", {
          accessToken,
          memberId,
          token,
          nickname,
          isNewMember,
          isExisting,
        });

        if (isExisting === "true" && memberId && token) {
          // 기존 회원 로그인 성공
          const user = {
            id: memberId,
            member_id: memberId, // 호환성을 위해 두 키 모두 제공
            token: token,
            nickname: nickname || "사용자",
            loginTime: Date.now(),
          };

          localStorage.setItem("voin_login", JSON.stringify(user));
          updateLoginUI(true, user);
          showStatus("로그인이 완료되었습니다!", false);
        } else if (isNewMember === "true" && accessToken) {
          // 신규 회원 - 회원가입 필요
          showStatus(
            "회원가입이 필요합니다. 닉네임 설정 페이지로 이동합니다.",
            false
          );
          setTimeout(() => {
            window.location.href = `/signup/nickname?access_token=${accessToken}`;
          }, 2000);
        } else {
          showStatus("로그인 처리 중 문제가 발생했습니다.", true);
        }

        // URL 정리
        window.history.replaceState(
          {},
          document.title,
          window.location.pathname
        );
      }

      // 로그인 UI 업데이트
      function updateLoginUI(isLoggedIn, user = null) {
        state.isLoggedIn = isLoggedIn;
        state.user = user;

        const loginRequired = document.getElementById("loginRequired");
        const loggedInStatus = document.getElementById("loggedInStatus");
        const userNickname = document.getElementById("userNickname");
        const userAvatar = document.getElementById("userAvatar");

        if (isLoggedIn && user) {
          loginRequired.style.display = "none";
          loggedInStatus.style.display = "block";
          userNickname.textContent = user.nickname || "사용자";
          userAvatar.textContent = (user.nickname || "사용자")[0];
        } else {
          loginRequired.style.display = "block";
          loggedInStatus.style.display = "none";
        }
      }

      // 로그아웃
      function logout() {
        localStorage.removeItem("voin_login");
        updateLoginUI(false);
        showStatus("로그아웃되었습니다.", false);
      }

      // 기능 페이지로 이동
      function navigateToFeature(url) {
        if (!state.isLoggedIn) {
          showStatus("로그인이 필요한 기능입니다.", true);
          return;
        }
        window.location.href = url;
      }

      // 상태 메시지 표시
      function showStatus(message, isError = false) {
        const statusEl = document.getElementById("loginStatus");
        statusEl.style.display = "block";
        statusEl.textContent = message;
        statusEl.className = `status ${isError ? "error" : "success"}`;

        // 3초 후 자동 숨김
        setTimeout(() => {
          statusEl.style.display = "none";
        }, 3000);
      }

      // 페이지 초기화 실행
      initializePage();
    </script>
  </body>
</html>
