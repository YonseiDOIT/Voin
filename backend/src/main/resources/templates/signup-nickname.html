<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‹‰ë„¤ì„ ì„¤ì • - VOIN</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .signup-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
      }

      .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: bold;
        color: white;
      }

      .step.active {
        background: #667eea;
      }

      .step.inactive {
        background: #ccc;
      }

      .step-line {
        width: 40px;
        height: 2px;
        background: #ccc;
        margin-top: 19px;
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        line-height: 1.5;
      }

      .nickname-form {
        margin-bottom: 30px;
      }

      .nickname-options {
        margin-bottom: 20px;
      }

      .option {
        display: flex;
        align-items: center;
        padding: 15px;
        border: 2px solid #e1e1e1;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .option:hover {
        border-color: #667eea;
        background-color: #f8f9ff;
      }

      .option.selected {
        border-color: #667eea;
        background-color: #667eea;
        color: white;
      }

      .option input[type="radio"] {
        margin-right: 10px;
      }

      .custom-nickname {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e1e1;
        border-radius: 10px;
        font-size: 16px;
        margin-top: 10px;
        display: none;
      }

      .custom-nickname.show {
        display: block;
      }

      .next-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.3s ease;
        width: 100%;
      }

      .next-button:hover {
        transform: translateY(-2px);
      }

      .next-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        color: #e74c3c;
        margin-top: 10px;
        display: none;
      }

      .preview {
        background: #f8f9ff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #e1e1e1;
      }

      .preview h3 {
        color: #667eea;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="signup-container">
      <!-- ë‹¨ê³„ í‘œì‹œ -->
      <div class="step-indicator">
        <div class="step active">1</div>
        <div class="step-line"></div>
        <div class="step inactive">2</div>
      </div>

      <h1>ğŸ­ ë‹‰ë„¤ì„ ì„¤ì •</h1>
      <p class="subtitle">
        VOINì—ì„œ ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.<br />
        ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.
      </p>

      <div class="preview">
        <h3>í˜„ì¬ ì„ íƒëœ ë‹‰ë„¤ì„</h3>
        <div id="preview-nickname">ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>

      <form class="nickname-form" id="nicknameForm">
        <div class="nickname-options">
          <div class="option" onclick="selectOption('kakao')">
            <input
              type="radio"
              name="nicknameType"
              value="kakao"
              id="kakao-option"
            />
            <label for="kakao-option">
              <strong>ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„ ì‚¬ìš©</strong><br />
              <span id="kakao-nickname">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </label>
          </div>

          <div class="option" onclick="selectOption('custom')">
            <input
              type="radio"
              name="nicknameType"
              value="custom"
              id="custom-option"
            />
            <label for="custom-option">
              <strong>ìƒˆë¡œìš´ ë‹‰ë„¤ì„ ì„¤ì •</strong><br />
              ì›í•˜ëŠ” ë‹‰ë„¤ì„ì„ ì§ì ‘ ì…ë ¥í•´ë³´ì„¸ìš”
            </label>
          </div>
        </div>

        <input
          type="text"
          class="custom-nickname"
          id="customNickname"
          placeholder="2-10ì ì‚¬ì´ì˜ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
          maxlength="10"
        />

        <div class="error-message" id="errorMessage"></div>

        <button type="submit" class="next-button" id="nextButton">
          ë‹¤ìŒ ë‹¨ê³„ â†’
        </button>
      </form>
    </div>

    <script th:inline="javascript">
      const accessToken = /*[[${accessToken}]]*/ "";
      let kakaoUserInfo = null;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
      async function loadKakaoUserInfo() {
        if (!accessToken) {
          showError("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          return;
        }

        try {
          const response = await fetch("/signup/start", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `access_token=${accessToken}`,
          });

          const result = await response.json();

          if (result.success && result.data) {
            kakaoUserInfo = result.data.kakaoUserInfo;
            document.getElementById("kakao-nickname").textContent =
              kakaoUserInfo.nickname;
            document.getElementById("preview-nickname").textContent =
              kakaoUserInfo.nickname;

            // ê¸°ë³¸ìœ¼ë¡œ ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„ ì„ íƒ
            selectOption("kakao");
          } else {
            showError(result.message || "ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          showError("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          console.error("Error:", error);
        }
      }

      function selectOption(type) {
        // ëª¨ë“  ì˜µì…˜ ì„ íƒ í•´ì œ
        document
          .querySelectorAll(".option")
          .forEach((opt) => opt.classList.remove("selected"));
        document
          .querySelectorAll('input[name="nicknameType"]')
          .forEach((input) => (input.checked = false));

        // ì„ íƒëœ ì˜µì…˜ í™œì„±í™”
        const selectedOption = document.querySelector(
          `#${type}-option`
        ).parentElement;
        selectedOption.classList.add("selected");
        document.getElementById(`${type}-option`).checked = true;

        // ì»¤ìŠ¤í…€ ë‹‰ë„¤ì„ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        const customInput = document.getElementById("customNickname");
        if (type === "custom") {
          customInput.classList.add("show");
          customInput.focus();
        } else {
          customInput.classList.remove("show");
          customInput.value = "";
        }

        updatePreview();
      }

      function updatePreview() {
        const selectedType = document.querySelector(
          'input[name="nicknameType"]:checked'
        )?.value;
        const preview = document.getElementById("preview-nickname");

        if (selectedType === "kakao" && kakaoUserInfo) {
          preview.textContent = kakaoUserInfo.nickname;
        } else if (selectedType === "custom") {
          const customValue = document.getElementById("customNickname").value;
          preview.textContent = customValue || "ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”";

          // ì‹¤ì‹œê°„ ìœ íš¨ì„± ê²€ì¦
          validateNickname(customValue);
        }
      }

      function validateNickname(nickname) {
        const errorElement = document.getElementById("errorMessage");

        if (!nickname) {
          errorElement.style.display = "none";
          return;
        }

        // ê¸€ì ìˆ˜ ì œí•œ ê²€ì¦
        if (nickname.length > 10) {
          showError("10ê¸€ì ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // íŠ¹ìˆ˜ë¬¸ì ë° ê³µë°± ê²€ì¦
        const validPattern = /^[ê°€-í£a-zA-Z0-9]+$/;
        if (!validPattern.test(nickname)) {
          showError("ê³µë°±ì—†ì´ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return false;
        }

        // ëª¨ë“  ê²€ì¦ í†µê³¼
        errorElement.style.display = "none";
        return true;
      }

      // ì»¤ìŠ¤í…€ ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
      document
        .getElementById("customNickname")
        .addEventListener("input", updatePreview);

      // í¼ ì œì¶œ ì²˜ë¦¬
      document
        .getElementById("nicknameForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const selectedType = document.querySelector(
            'input[name="nicknameType"]:checked'
          )?.value;
          const customNickname = document
            .getElementById("customNickname")
            .value.trim();

          if (!selectedType) {
            showError("ë‹‰ë„¤ì„ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
          }

          if (selectedType === "custom") {
            if (!customNickname) {
              showError("ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            // ê¸€ì ìˆ˜ ì œí•œ ê²€ì¦
            if (customNickname.length > 10) {
              showError("10ê¸€ì ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            // íŠ¹ìˆ˜ë¬¸ì ë° ê³µë°± ê²€ì¦
            const validPattern = /^[ê°€-í£a-zA-Z0-9]+$/;
            if (!validPattern.test(customNickname)) {
              showError("ê³µë°±ì—†ì´ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }

            if (customNickname.length < 2) {
              showError("ë‹‰ë„¤ì„ì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
              return;
            }
          }

          const requestData = {
            accessToken: accessToken,
            nickname:
              selectedType === "custom"
                ? customNickname
                : kakaoUserInfo?.nickname || "",
            useKakaoNickname: selectedType === "kakao",
          };

          try {
            document.getElementById("nextButton").disabled = true;

            const response = await fetch("/signup/nickname", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            });

            const result = await response.json();

            if (result.success) {
              // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
              window.location.href = `/signup/profile-image?access_token=${accessToken}`;
            } else {
              showError(result.message || "ë‹‰ë„¤ì„ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              document.getElementById("nextButton").disabled = false;
            }
          } catch (error) {
            showError("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            document.getElementById("nextButton").disabled = false;
            console.error("Error:", error);
          }
        });

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        errorElement.textContent = message;
        errorElement.style.display = "block";

        setTimeout(() => {
          errorElement.style.display = "none";
        }, 5000);
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      loadKakaoUserInfo();
    </script>
  </body>
</html>
