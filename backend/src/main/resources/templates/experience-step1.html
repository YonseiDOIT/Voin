<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‚¬ë¡€ ëŒì•„ë³´ê¸° 1ë‹¨ê³„ - Voin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      }

      .progress-bar {
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        margin-bottom: 30px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 50%;
        transition: width 0.3s ease;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .step-indicator {
        color: #667eea;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 10px;
      }

      .context-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .context-info .label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .context-info .title {
        font-size: 1.1rem;
        font-weight: bold;
      }

      .header h1 {
        color: #333;
        font-size: 1.8rem;
        margin-bottom: 15px;
        line-height: 1.4;
      }

      .header .description {
        color: #666;
        font-size: 1rem;
        line-height: 1.6;
      }

      .form-section {
        margin-bottom: 40px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        color: #333;
        font-weight: 600;
        margin-bottom: 12px;
        font-size: 1.1rem;
      }

      .form-group textarea {
        width: 100%;
        min-height: 150px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 15px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.3s ease;
        background: #f9f9f9;
      }

      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .char-counter {
        text-align: right;
        color: #999;
        font-size: 0.9rem;
        margin-top: 8px;
      }

      .char-counter.warning {
        color: #f39c12;
      }

      .char-counter.error {
        color: #e74c3c;
      }

      .buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 40px;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-back {
        background: #e0e0e0;
        color: #333;
      }

      .btn-back:hover {
        background: #d0d0d0;
      }

      .btn-next {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-next.enabled {
        opacity: 1;
        cursor: pointer;
      }

      .btn-next.enabled:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }

      .loading {
        display: none;
        text-align: center;
        color: #667eea;
        font-size: 1.1rem;
        margin-top: 20px;
      }

      .tips {
        background: #f0f4f8;
        border-left: 4px solid #667eea;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .tips h3 {
        color: #667eea;
        font-size: 1rem;
        margin-bottom: 10px;
      }

      .tips ul {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.6;
        padding-left: 20px;
      }

      .tips li {
        margin-bottom: 5px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 30px 20px;
          margin: 10px;
        }

        .header h1 {
          font-size: 1.5rem;
        }

        .buttons {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>

      <div class="header">
        <div class="step-indicator">STEP 1 / 2</div>
        <div class="context-info" id="contextInfo">
          <div class="label">ì„ íƒëœ ìƒí™© ë§¥ë½</div>
          <div class="title" id="contextTitle">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        <h1>ğŸ“ ê·¸ë•Œ ë‚˜ëŠ” ì–´ë–¤ í–‰ë™ì„ í–ˆì—ˆë‚˜ìš”?</h1>
        <p class="description">
          ì„ íƒí•˜ì‹  ìƒí™©ì—ì„œ ì—¬ëŸ¬ë¶„ì´ ì‹¤ì œë¡œ í–ˆë˜ í–‰ë™ì´ë‚˜ ë§,<br />
          ë˜ëŠ” ë³´ì—¬ì£¼ì—ˆë˜ ëª¨ìŠµì„ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ë³´ì„¸ìš”.
        </p>
      </div>

      <div class="tips">
        <h3>ğŸ’¡ ì‘ì„± íŒ</h3>
        <ul>
          <li>êµ¬ì²´ì ì¸ í–‰ë™ì´ë‚˜ ë§ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”</li>
          <li>"ê·¸ë•Œ ë‚˜ëŠ” ~í–ˆë‹¤" í˜•íƒœë¡œ ì‘ì„±í•˜ë©´ ì¢‹ìŠµë‹ˆë‹¤</li>
          <li>ê°ì •ë³´ë‹¤ëŠ” ì‹¤ì œ í–‰ë™ì— ì§‘ì¤‘í•´ì„œ ì¨ì£¼ì„¸ìš”</li>
          <li>ìµœì†Œ 50ì ì´ìƒ ì‘ì„±í•´ì£¼ì‹œë©´ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”</li>
        </ul>
      </div>

      <div class="form-section">
        <div class="form-group">
          <label for="actionDescription">ë‚˜ì˜ í–‰ë™ *</label>
          <textarea
            id="actionDescription"
            placeholder="ì˜ˆ: íŒ€ í”„ë¡œì íŠ¸ì—ì„œ ì˜ê²¬ì´ ì¶©ëŒí–ˆì„ ë•Œ, ë‚˜ëŠ” ê°ìì˜ ì˜ê²¬ì„ ì •ë¦¬í•´ì„œ í™”ì´íŠ¸ë³´ë“œì— ì ê³ , í•˜ë‚˜ì”© ì¥ë‹¨ì ì„ í•¨ê»˜ ì´ì•¼ê¸°í•˜ìê³  ì œì•ˆí–ˆë‹¤. ê·¸ë¦¬ê³  ëª¨ë“  ì‚¬ëŒì´ ë°œì–¸í•  ìˆ˜ ìˆë„ë¡ ìˆœì„œë¥¼ ì •í•´ì„œ ëŒì•„ê°€ë©° ì˜ê²¬ì„ ë“¤ì—ˆë‹¤."
            maxlength="500"
            oninput="updateCharCounter()"
            onkeyup="checkFormValid()"
          ></textarea>
          <div class="char-counter" id="charCounter">0 / 500ì</div>
        </div>
      </div>

      <div class="buttons">
        <button class="btn btn-back" onclick="goBack()">ğŸ”™ ì´ì „ìœ¼ë¡œ</button>
        <button
          id="nextBtn"
          class="btn btn-next"
          disabled
          onclick="proceedToStep2()"
        >
          ë‹¤ìŒ ë‹¨ê³„ ğŸš€
        </button>
      </div>

      <div class="loading" id="loading">í–‰ë™ ë‚´ìš©ì„ ì €ì¥í•˜ëŠ” ì¤‘... â³</div>
    </div>

    <script>
      let contextId = null;
      let contextTitle = "";

      // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„°ì—ì„œ ìƒí™© ë§¥ë½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        contextId = urlParams.get("contextId");
        contextTitle = urlParams.get("contextTitle");

        if (!contextId || !contextTitle) {
          alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ìƒí™© ë§¥ë½ ì„ íƒ í˜ì´ì§€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
          window.location.href = "/situation-context-selection";
          return;
        }

        // ìƒí™© ë§¥ë½ ì •ë³´ í‘œì‹œ
        document.getElementById("contextTitle").textContent = contextTitle;

        // í…ìŠ¤íŠ¸ì˜ì—­ í¬ì»¤ìŠ¤
        document.getElementById("actionDescription").focus();
      });

      function updateCharCounter() {
        const textarea = document.getElementById("actionDescription");
        const counter = document.getElementById("charCounter");
        const length = textarea.value.length;

        counter.textContent = `${length} / 500ì`;

        if (length > 450) {
          counter.className = "char-counter error";
        } else if (length > 350) {
          counter.className = "char-counter warning";
        } else {
          counter.className = "char-counter";
        }
      }

      function checkFormValid() {
        const actionDescription = document
          .getElementById("actionDescription")
          .value.trim();
        const nextBtn = document.getElementById("nextBtn");

        if (actionDescription.length >= 10) {
          nextBtn.disabled = false;
          nextBtn.classList.add("enabled");
        } else {
          nextBtn.disabled = true;
          nextBtn.classList.remove("enabled");
        }
      }

      function goBack() {
        const params = new URLSearchParams({
          contextId: contextId,
          contextTitle: contextTitle,
        });
        window.location.href = `/situation-context-selection?${params.toString()}`;
      }

      async function proceedToStep2() {
        const actionDescription = document
          .getElementById("actionDescription")
          .value.trim();

        if (!actionDescription || actionDescription.length < 10) {
          alert("í–‰ë™ ë‚´ìš©ì„ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        const loading = document.getElementById("loading");
        const nextBtn = document.getElementById("nextBtn");

        try {
          loading.style.display = "block";
          nextBtn.disabled = true;

          const response = await fetch(
            "/api/coin-finder/experience-review/step1",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                situationContextId: parseInt(contextId),
                actionDescription: actionDescription,
              }),
            }
          );

          const result = await response.json();

          if (result.success) {
            // 2ë‹¨ê³„ë¡œ ì´ë™
            const params = new URLSearchParams({
              formId: result.data.formId,
              contextId: contextId,
              contextTitle: contextTitle,
              actionDescription: actionDescription,
            });

            window.location.href = `/experience-step2?${params.toString()}`;
          } else {
            throw new Error(result.message || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
          console.error("Error saving step 1:", error);
          alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          nextBtn.disabled = false;
          nextBtn.classList.add("enabled");
        } finally {
          loading.style.display = "none";
        }
      }

      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì§€ì› (Ctrl+Enterë¡œ ë‹¤ìŒ ë‹¨ê³„)
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey && e.key === "Enter") {
          if (!document.getElementById("nextBtn").disabled) {
            proceedToStep2();
          }
        }
      });

      // ìë™ ì €ì¥ ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)
      let autoSaveTimeout;
      document
        .getElementById("actionDescription")
        .addEventListener("input", function () {
          clearTimeout(autoSaveTimeout);
          autoSaveTimeout = setTimeout(() => {
            const content = this.value.trim();
            if (content.length > 0) {
              localStorage.setItem("experienceStep1_action", content);
            }
          }, 1000);
        });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì €ì¥ëœ ë‚´ìš© ë³µì›
      window.addEventListener("load", function () {
        const savedContent = localStorage.getItem("experienceStep1_action");
        if (savedContent) {
          document.getElementById("actionDescription").value = savedContent;
          updateCharCounter();
          checkFormValid();
        }
      });
    </script>
  </body>
</html>
